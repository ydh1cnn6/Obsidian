---
title: 未命名 2
updateDate: 2025-11-27 10:59:38
---

```dataviewjs
// ==============================================================================
// ==                          配置与常量                                       ==
// ==============================================================================

/**
 * 需要加载的外部库列表
 */
const LIBRARIES = [
    { src: 'https://cdn.jsdelivr.net/npm/marked/marked.min.js', name: 'marked' },
    { src: 'https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js', name: 'DOMPurify' },
    { src: 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js', name: 'Sortable' },
    { src: 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js', name: 'hljs' }
];

/**
 * CSS 样式表 - 优化了内容间距
 */
const CSS_STYLES = `
  /* --- 代码高亮 --- */
  .hljs { display: block; overflow-x: auto; padding: 0.5em; color: #c9d1d9; background: #0d1117; }
  .hljs-doctag, .hljs-keyword, .hljs-meta .hljs-keyword, .hljs-template-tag, .hljs-template-variable, .hljs-type, .hljs-variable.language_ { color: #ff7300; }
  .hljs-title, .hljs-title.class_, .hljs-title.class_.inherited__, .hljs-title.function_ { color: #3fb950; }
  .hljs-attr, .hljs-attribute, .hljs-literal, .hljs-meta, .hljs-number, .hljs-operator, .hljs-variable, .hljs-selector-attr, .hljs-selector-class, .hljs-selector-id { color: #79c0ff; }
  .hljs-regexp, .hljs-string, .hljs-meta .hljs-string { color: #e3b341; }
  .hljs-built_in, .hljs-symbol { color: #f8d583; }
  .hljs-comment, .hljs-code, .hljs-formula { color: #8b949e; }
  .hljs-name, .hljs-quote, .hljs-selector-pseudo, .hljs-selector-tag { color: #d2a8ff; }
  .hljs-subst { color: #c9d1d9; }
  .hljs-section { color: #1f6feb; font-weight: bold; }
  .hljs-bullet { color: #f2cc60; }
  .hljs-emphasis { color: #c9d1d9; font-style: italic; }
  .hljs-strong { color: #c9d1d9; font-weight: bold; }

  /* --- 编辑器内容 - 优化间距版本 --- */
  .editor-content > h1, 
  .editor-content > h2, 
  .editor-content > h3, 
  .editor-content > h4, 
  .editor-content > h5, 
  .editor-content > h6 {
    margin-top: 0.8em !important;  /* 标题上方保留一定间距 */
    margin-bottom: 0.4em !important; /* 标题下方间距减小 */
    line-height: 1.3 !important;
  }
  
  .editor-content > p {
    margin-top: 0 !important;
    margin-bottom: 0.4em !important; /* 段落间距减小 */
    line-height: 1.5 !important;
  }
  
  .editor-content > ul, 
  .editor-content > ol {
    margin-top: 0.2em !important;
    margin-bottom: 0.4em !important; /* 列表整体间距减小 */
    padding-left: 1.5em !important;
  }
  
  .editor-content > ul li, 
  .editor-content > ol li { 
    margin-bottom: 0.2em !important; /* 列表项之间间距减小 */
    line-height: 1.5 !important;
  }
  
  .editor-content > pre { 
    padding: 0.6em !important; 
    margin: 0.5em 0 !important; /* 代码块间距适中 */
    line-height: 1.4 !important;
  }
  
  .editor-content > blockquote {
    margin: 0.5em 0 !important;
    padding: 0.4em 0.8em !important;
    line-height: 1.5 !important;
  }
  
  .editor-content > table {
    margin: 0.5em 0 !important;
    border-collapse: collapse !important;
  }
  
  .editor-content > table th,
  .editor-content > table td {
    padding: 0.3em 0.6em !important;
    border: 1px solid #ddd !important;
  }

  /* --- 动作按钮组 --- */
  .action-buttons { display: flex; flex-direction: column; align-items: center; gap: 8px; }
  
  /* --- 拖拽手柄 --- */
  .drag-handle {
    cursor: grab; color: #6366f1; user-select: none; font-size: 1.4em;
    width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
    border-radius: 50%; transition: background-color 0.2s ease;
  }
  .drag-handle:hover { background-color: rgba(99, 102, 241, 0.1); }
  .drag-handle:active { cursor: grabbing; color: #4f46e5; }
  
  /* --- 删除按钮 --- */
  .delete-column-btn {
    background: transparent !important; color: #ef4444 !important; border: none !important; outline: none !important;
    cursor: pointer; font-size: 1.2em; padding: 0; user-select: none;
    width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; border-radius: 30%;
    transition: color 0.2s ease;
  }
  .delete-column-btn:hover { color: #f87171 !important; }
  .delete-column-btn:active { color: #dc2626 !important; }

  /* --- 保存指示器 --- */
  #save-indicator {
    position: absolute; top: 10px; right: 20px;
    background-color: rgba(79, 70, 229, 0.8); color: white;
    padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 500;
    opacity: 0; transition: opacity 0.3s ease; pointer-events: none; z-index: 1000;
  }
  #save-indicator.visible { opacity: 1; }

  /* --- 列标题 --- */
  .column-title {
    min-width: 50px; padding: 2px 4px; border-radius: 4px;
    transition: border 0.2s ease; border: 1px solid transparent;
  }
  .column-title:hover { border-color: #e5e7eb; }
  .column-title:focus { outline: none; border: 1px solid #6366f1; background-color: #f9fafb; }
  
  /* --- 空状态 --- */
  .empty-state {
      display: flex; justify-content: center; align-items: center; height: 100%;
      color: #9ca3af; font-style: italic;
  }

  /* --- 调整大小状态 --- */
  .resizing-body * { pointer-events: none !important; }
  .resizing-body .resizer, .resizing-body .resizer * { pointer-events: auto !important; }

  /* --- 编辑模式 --- */
  .editor-content.editing {
    background-color: #ffffff !important; border: 2px solid #6366f1 !important;
    border-radius: 4px; padding: 8px !important; pointer-events: auto !important; z-index: 10 !important;
  }

  /* --- 列容器和列 --- */
  #column-container {
    display: flex; width: 100%; border: 3px solid #6366f1; border-radius: 12px;
    overflow: hidden; height: 450px; box-sizing: border-box;
  }
  .column {
    flex: 1 1; padding: 1px; background: #f9fafb; box-sizing: border-box;
    overflow: auto; display: flex; flex-direction: column; transition: all 0.1s linear;
  }
  
  /* --- 调整器 --- */
  .resizer {
    width: 12px; background: rgba(99, 102, 241, 0.1); position: relative;
    touch-action: none; cursor: col-resize; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; z-index: 10;
  }
  .resizer .inner-bar {
    width: 4px; height: 80px; background: #6366f1; border-radius: 2px;
  }
  
  /* --- 自定义确认对话框 --- */
  .custom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }

  .custom-modal-content {
    background-color: white;
    padding: 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    width: 90%;
    display: flex;
    flex-direction: column;
    animation: modal-appear 0.2s ease-out;
  }

  @keyframes modal-appear {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .custom-modal-message {
    margin-bottom: 20px;
    font-size: 16px;
    color: #333;
    line-height: 1.4;
    text-align: center;
  }

  .custom-modal-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .custom-modal-button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.15s ease;
    min-width: 70px;
  }

  .custom-modal-confirm {
    background-color: #dc2626;
    color: white;
  }

  .custom-modal-confirm:hover {
    background-color: #b91c1c;
  }

  .custom-modal-cancel {
    background-color: #6b7280;
    color: white;
  }

  .custom-modal-cancel:hover {
    background-color: #4b5563;
  }
`;

// ==============================================================================
// ==                          核心组件                                         ==
// ==============================================================================

/**
 * 多栏编辑器组件
 */
class MultiColumnEditor {
    constructor(container) {
        this.container = container;
        this.state = {
            columns: [],
            sortableInstance: null,
            isResizing: false,
            startX: 0,
            initialLeftWidth: 0,
            initialRightWidth: 0,
            leftColEl: null,
            rightColEl: null,
            deleteInProgress: false,
            syncInProgress: false,
            modalActive: false
        };
        this.elements = { columnContainer: null, addColumnBtn: null, saveIndicator: null };
        this.loadedLibraries = new Set();
        this.globalEventListeners = new Map();
        this.modalResolve = null;
    }

    // --------------------------------------------------------------------------
    // --- 工具函数 ---
    // --------------------------------------------------------------------------

    getNoteUniqueId() {
        return dv.current().file.path.replace(/\//g, '_');
    }

    loadLibrary(lib) {
        return new Promise((resolve, reject) => {
            if (this.loadedLibraries.has(lib.name) && window[lib.name]) {
                return resolve();
            }
            const script = document.createElement('script');
            script.src = lib.src;
            script.onload = () => {
                this.loadedLibraries.add(lib.name);
                resolve();
            };
            script.onerror = () => {
                reject(new Error(`Failed to load ${lib.name}`));
            };
            document.head.appendChild(script);
        });
    }

    // 自定义确认对话框（替代原生confirm）
    showCustomConfirm(message) {
        return new Promise((resolve) => {
            this.state.modalActive = true;
            this.modalResolve = resolve;
            
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            modal.innerHTML = `
                <div class="custom-modal-content">
                    <div class="custom-modal-message">${message}</div>
                    <div class="custom-modal-buttons">
                        <button class="custom-modal-button custom-modal-confirm">确定</button>
                        <button class="custom-modal-button custom-modal-cancel">取消</button>
                    </div>
                </div>
            `;
            
            // 添加到文档
            document.body.appendChild(modal);
            
            // 绑定事件
            modal.querySelector('.custom-modal-cancel').addEventListener('click', () => {
                document.body.removeChild(modal);
                this.state.modalActive = false;
                this.modalResolve(false);
            });
            
            modal.querySelector('.custom-modal-confirm').addEventListener('click', () => {
                document.body.removeChild(modal);
                this.state.modalActive = false;
                this.modalResolve(true);
            });
        });
    }

    // --------------------------------------------------------------------------
    // --- DOM 操作与渲染 ---
    // --------------------------------------------------------------------------

    injectStyles() {
        const styleElement = document.createElement('style');
        styleElement.textContent = CSS_STYLES;
        document.head.appendChild(styleElement);
    }

    createResizer() {
        const resizer = document.createElement('div');
        resizer.className = 'resizer';
        const innerBar = document.createElement('div');
        innerBar.className = 'inner-bar';
        resizer.appendChild(innerBar);
        return resizer;
    }

    createColumnElement(data) {
        const column = document.createElement('div');
        column.className = 'column';
        if (data.width) column.style.flexBasis = data.width;

        const renderedContent = this.renderMarkdown(data.content || '');

        column.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #6366f1;">
              <span class="column-title" contenteditable="true" spellcheck="false">${data.title}</span>
              <div class="action-buttons">
                <span class="drag-handle">☰</span>
                <button class="delete-column-btn" type="button">✕</button>
              </div>
            </div>
            <div class="editor-content" style="flex-grow: 1; min-height: 350px; outline: none; font-size: 15px; line-height: 1.6; color: #374151; white-space: pre-wrap; word-break: break-word; padding: 0 5px;" contenteditable="true" data-markdown="${this.escapeHtml(data.content || '')}">${renderedContent}</div>
        `;
        return column;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    renderMarkdown(markdownText = '') {
        if (!window.marked || !window.DOMPurify) {
            return markdownText;
        }

        const renderer = new window.marked.Renderer();
        renderer.code = (code, language) => {
            if (!window.hljs) return `<pre><code>${window.DOMPurify.sanitize(code)}</code></pre>`;
            try {
                const result = language && window.hljs.getLanguage(language)
                    ? window.hljs.highlight(code, { language })
                    : window.hljs.highlightAuto(code);
                return `<pre><code class="hljs language-${result.language}">${result.value}</code></pre>`;
            } catch (err) {
                return `<pre><code class="hljs">${window.DOMPurify.sanitize(code)}</code></pre>`;
            }
        };

        return window.DOMPurify.sanitize(
            window.marked.parse(markdownText, { renderer, gfm: true, breaks: true, smartLists: true })
        );
    }

    // --------------------------------------------------------------------------
    // --- 数据持久化 ---
    // --------------------------------------------------------------------------

    loadColumnsData() {
        try {
            const data = localStorage.getItem(`multiColumnData_${this.getNoteUniqueId()}`);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            localStorage.removeItem(`multiColumnData_${this.getNoteUniqueId()}`);
            return null;
        }
    }

    saveColumnsData() {
        this.elements.saveIndicator?.classList.add('visible');

        requestAnimationFrame(() => {
            try {
                const currentColumns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
                const data = currentColumns.map((col, index) => ({
                    title: col.querySelector('.column-title').innerText.trim() || `分栏 ${index + 1}`,
                    content: col.querySelector('.editor-content').dataset.markdown || '',
                    width: col.style.flexBasis || `${100 / currentColumns.length}%`
                }));
                localStorage.setItem(`multiColumnData_${this.getNoteUniqueId()}`, JSON.stringify(data));
            } catch (e) {
                console.error('保存数据失败:', e);
            } finally {
                setTimeout(() => this.elements.saveIndicator?.classList.remove('visible'), 300);
            }
        });
    }

    // --------------------------------------------------------------------------
    // --- 事件处理 ---
    // --------------------------------------------------------------------------

    bindEvents() {
        this.bindGlobalClickHandler();
        this.bindAddColumnButton();
        this.elements.columnContainer.addEventListener('click', (e) => this.handleColumnContainerClick(e));
        this.elements.columnContainer.addEventListener('mousedown', (e) => this.handleColumnContainerMouseDown(e));
        this.elements.columnContainer.addEventListener('blur', (e) => this.handleColumnContainerBlur(e), true);
        this.elements.columnContainer.addEventListener('keydown', (e) => this.handleColumnContainerKeydown(e));
    }

    bindGlobalClickHandler() {
        const handler = (e) => {
            if (!this.elements.columnContainer.contains(e.target) && !this.state.modalActive) {
                this.syncEditingContent();
            }
        };
        document.addEventListener('click', handler);
        this.globalEventListeners.set('document:click', handler);
    }

    bindAddColumnButton() {
        this.elements.addColumnBtn.addEventListener('click', () => this.addNewColumn());
    }

    handleColumnContainerClick(e) {
        const deleteBtn = e.target.closest('.delete-column-btn');
        if (deleteBtn) {
            e.preventDefault();
            e.stopPropagation();
            const column = deleteBtn.closest('.column');
            if (column) this.deleteColumn(column);
        }
    }

    handleColumnContainerMouseDown(e) {
        const resizer = e.target.closest('.resizer');
        if (resizer) {
            this.startResize(e, resizer);
            return;
        }

        const editorContent = e.target.closest('.editor-content');
        if (editorContent && !editorContent.classList.contains('editing')) {
            this.syncEditingContent();
            this.enterEditMode(editorContent);
        }
    }

    handleColumnContainerBlur(e) {
        if (e.target.classList.contains('editor-content') && e.target.classList.contains('editing')) {
            this.exitEditMode(e.target);
        } else if (e.target.classList.contains('column-title')) {
            this.saveColumnsData();
        }
    }

    handleColumnContainerKeydown(e) {
        if (e.target.classList.contains('editor-content') && e.target.classList.contains('editing')) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            }
        } else if (e.target.classList.contains('column-title') && (e.key === 'Enter' || e.key === 'Escape')) {
            e.preventDefault();
            e.target.blur();
        }
    }

    // --------------------------------------------------------------------------
    // --- 核心功能 ---
    // --------------------------------------------------------------------------

    enterEditMode(editorEl) {
        const markdownContent = editorEl.dataset.markdown || '';
        editorEl.innerText = markdownContent;
        editorEl.classList.add('editing');
        setTimeout(() => {
            editorEl.focus({ preventScroll: true });
            const range = document.createRange();
            range.selectNodeContents(editorEl);
            range.collapse(false);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }, 0);
    }

    exitEditMode(editorEl) {
        if (this.state.syncInProgress) return;
        this.state.syncInProgress = true;

        const cleanedContent = editorEl.innerText.replace(/\n{3,}/g, '\n\n');
        editorEl.dataset.markdown = cleanedContent;
        editorEl.classList.remove('editing');
        editorEl.innerHTML = this.renderMarkdown(cleanedContent);

        this.saveColumnsData();
        this.state.syncInProgress = false;
    }

    syncEditingContent() {
        const editingEditors = this.elements.columnContainer.querySelectorAll('.editor-content.editing');
        editingEditors.forEach(editor => this.exitEditMode(editor));
    }

    startResize(e, resizer) {
        if (this.state.isResizing) return;

        const resizerIndex = Array.from(this.elements.columnContainer.children).indexOf(resizer);
        this.state.leftColEl = this.elements.columnContainer.children[resizerIndex - 1];
        this.state.rightColEl = this.elements.columnContainer.children[resizerIndex + 1];

        if (!this.state.leftColEl || !this.state.rightColEl || !this.state.leftColEl.classList.contains('column')) return;

        this.state.isResizing = true;
        this.state.startX = e.clientX;
        this.state.initialLeftWidth = parseFloat(this.state.leftColEl.style.flexBasis || (100 / this.state.columns.length));
        this.state.initialRightWidth = parseFloat(this.state.rightColEl.style.flexBasis || (100 / this.state.columns.length));

        document.body.classList.add('resizing-body');
        document.addEventListener('mousemove', this.doResizeBound = (e) => this.doResize(e));
        document.addEventListener('mouseup', this.endResizeBound = () => this.endResize());
        document.addEventListener('mouseleave', this.endResizeBound);

        e.preventDefault();
        e.stopPropagation();
    }

    doResize(e) {
        if (!this.state.isResizing) return;

        const containerRect = this.elements.columnContainer.getBoundingClientRect();
        const mouseDelta = e.clientX - this.state.startX;
        const percentDelta = (mouseDelta / containerRect.width) * 100;

        const newLeftWidth = this.state.initialLeftWidth + percentDelta;
        const newRightWidth = this.state.initialRightWidth - percentDelta;
        const minWidth = 10;

        if (newLeftWidth >= minWidth && newRightWidth >= minWidth) {
            this.state.leftColEl.style.flexBasis = `${newLeftWidth}%`;
            this.state.rightColEl.style.flexBasis = `${newRightWidth}%`;
        }
        e.preventDefault();
    }

    endResize() {
        if (!this.state.isResizing) return;

        this.state.isResizing = false;
        document.body.classList.remove('resizing-body');
        document.removeEventListener('mousemove', this.doResizeBound);
        document.removeEventListener('mouseup', this.endResizeBound);
        document.removeEventListener('mouseleave', this.endResizeBound);

        this.saveColumnsData();
        this.state.leftColEl = null;
        this.state.rightColEl = null;
    }

    rebuildResizers() {
        this.elements.columnContainer.querySelectorAll('.resizer').forEach(resizer => resizer.remove());

        const columns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
        if (columns.length < 2) return;

        columns.forEach((col, index) => {
            if (index < columns.length - 1) {
                const resizer = this.createResizer();
                col.after(resizer);
            }
        });
    }

    initDragAndDrop() {
        if (this.state.sortableInstance) {
            this.state.sortableInstance.destroy();
        }

        const columns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
        if (columns.length <= 1) return;

        try {
            this.state.sortableInstance = new window.Sortable(this.elements.columnContainer, {
                animation: 500,
                handle: '.drag-handle',
                draggable: '.column',
                ghostClass: 'sortable-ghost',
                onStart: () => {
                    this.syncEditingContent();
                    document.body.style.userSelect = 'none';
                },
                onEnd: () => {
                    document.body.style.userSelect = '';
                    this.rebuildResizers();
                    this.saveColumnsData();
                }
            });
        } catch (e) {
            console.error('拖拽初始化失败:', e);
        }
    }

    addNewColumn(data = {}) {
        this.endResize();

        const columns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
        const newColCount = columns.length + 1;
        const newWidthPercent = `${100 / newColCount}%`;

        columns.forEach(col => {
            col.style.flexBasis = newWidthPercent;
        });

        const newColumnData = {
            title: data.title || `分栏 ${newColCount}`,
            content: data.content || `# 新分栏 ${newColCount}\n\n在这里输入你的内容，支持 **Markdown** 和代码高亮。\n\n点击分栏内容区域开始编辑。`,
            width: newWidthPercent
        };

        const newColumn = this.createColumnElement(newColumnData);
        this.elements.columnContainer.appendChild(newColumn);

        this.rebuildResizers();
        this.initDragAndDrop();
        this.saveColumnsData();

        setTimeout(() => {
            const editor = newColumn.querySelector('.editor-content');
            if (editor) {
                editor.click();
            }
        }, 100);
    }

    async deleteColumn(column) {
        if (this.state.deleteInProgress) return;
        this.state.deleteInProgress = true;

        const columnTitle = column.querySelector('.column-title').innerText;
        const columns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
        
        let confirmMessage = `确定要删除分栏 "${columnTitle}" 吗？内容将永久丢失！`;
        if (columns.length <= 1) {
            confirmMessage = '确定要删除最后一个分栏吗？此操作将清除所有本地存储的分栏数据！';
        }

        // 记录编辑状态
        const editor = column.querySelector('.editor-content');
        let wasEditing = false;
        let originalContent = '';
        
        if (editor && editor.classList.contains('editing')) {
            wasEditing = true;
            originalContent = editor.innerText;
            // 先退出编辑模式
            this.exitEditMode(editor);
        }

        // 使用自定义确认对话框替代原生confirm
        const confirmed = await this.showCustomConfirm(confirmMessage);
        
        if (!confirmed) {
            // 用户取消删除，恢复编辑状态
            if (wasEditing && editor) {
                // 恢复内容并重新进入编辑模式
                editor.dataset.markdown = originalContent;
                editor.innerHTML = this.renderMarkdown(originalContent);
                editor.classList.add('editing');
                
                // 使用requestAnimationFrame确保DOM更新后聚焦
                requestAnimationFrame(() => {
                    editor.focus({ preventScroll: true });
                    const range = document.createRange();
                    range.selectNodeContents(editor);
                    range.collapse(false);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                });
            }
            
            this.state.deleteInProgress = false;
            return;
        }

        // 用户确认删除
        column.remove();

        const remainingColumns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
        if (remainingColumns.length === 0) {
            this.elements.columnContainer.innerHTML = '<div class="empty-state">没有分栏，请点击上方 "+ 新增分栏" 按钮创建</div>';
            localStorage.removeItem(`multiColumnData_${this.getNoteUniqueId()}`);
        } else {
            const newWidthPercent = `${100 / remainingColumns.length}%`;
            remainingColumns.forEach(col => {
                col.style.flexBasis = newWidthPercent;
            });
            this.rebuildResizers();
            this.initDragAndDrop();
            this.saveColumnsData();

            // 删除后自动聚焦到第一个分栏
            setTimeout(() => {
                const firstColumn = remainingColumns[0];
                if (firstColumn) {
                    const firstEditor = firstColumn.querySelector('.editor-content');
                    if (firstEditor) {
                        firstEditor.click();
                    }
                }
            }, 50);
        }

        this.state.deleteInProgress = false;
    }

    // --------------------------------------------------------------------------
    // --- 初始化与销毁 ---
    // --------------------------------------------------------------------------

    render() {
        this.container.innerHTML = `
            <div style="position: relative; width: 100%; margin: 20px 0; box-sizing: border-box;">
                <div style="position: absolute; top: -20px; left: 10px; display: flex; gap: 10px; z-index: 999;">
                    <button id="add-column-btn" style="background: #6366f1; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 14px;">+ 新增分栏</button>
                </div>
                <div id="save-indicator">正在保存...</div>
                <div id="column-container"></div>
            </div>
        `;

        this.elements.columnContainer = this.container.querySelector('#column-container');
        this.elements.addColumnBtn = this.container.querySelector('#add-column-btn');
        this.elements.saveIndicator = this.container.querySelector('#save-indicator');
    }

    async init() {
        try {
            this.injectStyles();
            this.render();
            await Promise.all(LIBRARIES.map(lib => this.loadLibrary(lib)));
            
            const savedData = this.loadColumnsData();
            if (savedData && savedData.length > 0) {
                savedData.forEach(data => {
                    const column = this.createColumnElement(data);
                    this.elements.columnContainer.appendChild(column);
                });
                this.rebuildResizers();
            } else {
                this.addNewColumn({ title: '分栏 1', content: '# 分栏 1\n\n默认内容', width: '100%' });
            }
            
            this.bindEvents();
            this.initDragAndDrop();

        } catch (error) {
            this.container.innerHTML = `<div style="color: red; padding: 20px;">组件初始化失败: ${error.message}</div>`;
        }
    }

    destroy() {
        this.globalEventListeners.forEach((handler, key) => {
            const [target, event] = key.split(':');
            if (target === 'document') {
                document.removeEventListener(event, handler);
            }
        });
        this.globalEventListeners.clear();

        if (this.state.sortableInstance) {
            this.state.sortableInstance.destroy();
        }
        
        if (this.container) {
            this.container.innerHTML = '';
        }
    }
}

// ==============================================================================
// ==                          入口点                                           ==
// ==============================================================================

if (typeof dv !== 'undefined') {
    const editor = new MultiColumnEditor(dv.container);
    editor.init();

    module.exports = {
        destroy: () => editor.destroy()
    };
}
```
