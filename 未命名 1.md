---
title: 未命名 1
---

```dataviewjs
// 1. 动态引入所需库
const libraries = [
    { src: 'https://cdn.jsdelivr.net/npm/marked/marked.min.js', name: 'marked' },
    { src: 'https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js', name: 'DOMPurify' },
    { src: 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js', name: 'Sortable' },
    { src: 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js', name: 'hljs' }
];

const loadedLibraries = new Set();
const loadLibrary = (lib) => {
    return new Promise((resolve, reject) => {
        if (loadedLibraries.has(lib.name) && window[lib.name]) {
            return resolve();
        }
        const script = document.createElement('script');
        script.src = lib.src;
        script.onload = () => {
            loadedLibraries.add(lib.name);
            resolve();
        };
        script.onerror = () => reject(new Error(`Failed to load ${lib.name}`));
        document.head.appendChild(script);
    });
};

// --- 内嵌样式表 ---
const customStyle = document.createElement('style');
customStyle.textContent = `
  /* highlight.js 主题 */
  .hljs { display: block; overflow-x: auto; padding: 0.5em; color: #c9d1d9; background: #0d1117; }
  .hljs-doctag, .hljs-keyword, .hljs-meta .hljs-keyword, .hljs-template-tag, .hljs-template-variable, .hljs-type, .hljs-variable.language_ { color: #ff7300; }
  .hljs-title, .hljs-title.class_, .hljs-title.class_.inherited__, .hljs-title.function_ { color: #3fb950; }
  .hljs-attr, .hljs-attribute, .hljs-literal, .hljs-meta, .hljs-number, .hljs-operator, .hljs-variable, .hljs-selector-attr, .hljs-selector-class, .hljs-selector-id { color: #79c0ff; }
  .hljs-regexp, .hljs-string, .hljs-meta .hljs-string { color: #e3b341; }
  .hljs-built_in, .hljs-symbol { color: #f8d583; }
  .hljs-comment, .hljs-code, .hljs-formula { color: #8b949e; }
  .hljs-name, .hljs-quote, .hljs-selector-pseudo, .hljs-selector-tag { color: #d2a8ff; }
  .hljs-subst { color: #c9d1d9; }
  .hljs-section { color: #1f6feb; font-weight: bold; }
  .hljs-bullet { color: #f2cc60; }
  .hljs-emphasis { color: #c9d1d9; font-style: italic; }
  .hljs-strong { color: #c9d1d9; font-weight: bold; }

  /* Markdown 元素边距重置 */
  .editor-content > h1, .editor-content > h2, .editor-content > h3, .editor-content > h4, .editor-content > h5, .editor-content > h6, .editor-content > p, .editor-content > ul, .editor-content > ol, .editor-content > pre, .editor-content > blockquote, .editor-content > table {
    margin-top: 0 !important; margin-bottom: 0.75em !important;
  }
  .editor-content > ul li, .editor-content > ol li { margin-bottom: 0.3em !important; }
  .editor-content > pre { padding: 0.8em !important; margin-bottom: 1em !important; }

  /* 操作按钮容器 */
  .action-buttons {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px; /* 增大间距，视觉上更清晰 */
  }
  
  /* 拖拽手柄样式 */
  .drag-handle {
    cursor: grab;
    color: #6366f1; /* 使用主题色 */
    user-select: none;
    font-size: 1.4em; /* 统一尺寸 */
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%; /* 圆形背景 */
    transition: background-color 0.2s ease;
  }
  .drag-handle:hover {
    background-color: rgba(99, 102, 241, 0.1); /* hover 时显示背景 */
  }
  .drag-handle:active {
    cursor: grabbing;
    color: #4f46e5; /* 按下时颜色变深 */
  }
  
  /* --- 删除按钮样式 --- */
  .delete-column-btn {
    /* 明确重置所有可能影响外观的默认属性 */
    background: transparent !important; /* 强制透明背景 */
    color: #ef4444 !important; /* 强制红色文字 */
    border: none !important; /* 移除默认边框 */
    outline: none !important; /* 移除聚焦时的默认外边框 */
    
    cursor: pointer;
    font-size: 1.4em; /* 统一尺寸 */
    padding: 0;
    user-select: none;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%; /* 圆形点击区域 */
    /* 只过渡颜色，因为背景已经是透明的，且不需要缩放 */
    transition: color 0.2s ease;
  }
  .delete-column-btn:hover {
    color: #f87171 !important; /* hover 时颜色变深 */
  }
  .delete-column-btn:active {
    color: #dc2626 !important; /* 按下时颜色更深 */
  }

  /* 正在保存标识样式 */
  #save-indicator {
    position: absolute;
    top: 10px;
    right: 20px;
    background-color: rgba(79, 70, 229, 0.8); /* 主题色半透明 */
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none; /* 不阻挡点击 */
    z-index: 1000;
  }
  #save-indicator.visible {
    opacity: 1;
  }
`;
document.head.appendChild(customStyle);

// 2. 全局状态和 DOM 元素
let columns = [];
let sortableInstance = null;
const container = dv.container;
let columnContainer, addColumnBtn, saveIndicator; // 添加保存标识元素引用
let isResizing = false; let startX, initialLeftWidth, initialRightWidth, leftColEl, rightColEl;

// 3. 数据持久化
const getNoteUniqueId = () => dv.current().file.path.replace(/\//g, '_');

// 添加保存标识逻辑
const showSaveIndicator = () => {
    if (saveIndicator) {
        saveIndicator.classList.add('visible');
    }
};
const hideSaveIndicator = () => {
    if (saveIndicator) {
        saveIndicator.classList.remove('visible');
    }
};

const saveColumnsData = () => {
    showSaveIndicator(); // 开始保存时显示标识
    requestAnimationFrame(() => {
        try {
            syncEditingContent();
            const data = columns.map((col, index) => ({
                title: col.querySelector('.column-title').innerText.trim() || `分栏 ${index + 1}`,
                content: col.querySelector('.editor-content').dataset.markdown || '',
                width: col.style.flexBasis || `${100 / columns.length}%`
            }));
            localStorage.setItem(`multiColumnData_${getNoteUniqueId()}`, JSON.stringify(data));
        } catch (e) {
            console.error('分栏数据保存失败：', e);
        } finally {
            hideSaveIndicator(); // 保存完成（无论成败）后隐藏标识
        }
    });
};

const loadColumnsData = () => {
    try {
        const data = localStorage.getItem(`multiColumnData_${getNoteUniqueId()}`);
        return data ? JSON.parse(data) : null;
    } catch (e) {
        console.error('分栏数据读取失败：', e);
        localStorage.removeItem(`multiColumnData_${getNoteUniqueId()}`);
        return null;
    }
};

// 优化同步逻辑，确保状态正确重置
const syncEditingContent = () => {
  columns.forEach(col => {
    const editor = col.querySelector('.editor-content');
    if (editor.dataset.editing === 'true') {
      const cleanedContent = editor.innerText.replace(/\n{3,}/g, '\n\n');
      editor.dataset.markdown = cleanedContent;
      editor.dataset.editing = 'false';
    }
    // 强制重新渲染，确保内容是最新的Markdown解析结果
    editor.innerHTML = renderMarkdown(editor.dataset.markdown);
  });
};

const renderMarkdown = (markdownText = '') => {
  markdownText = String(markdownText || '');
  if (!window.marked || !window.DOMPurify) {
    console.warn('依赖库尚未加载完成，无法渲染Markdown。');
    return markdownText;
  }
  const renderer = new window.marked.Renderer();
  renderer.code = function(code, language) {
    code = String(code || '');
    if (!window.hljs) return `<pre><code>${window.DOMPurify.sanitize(code)}</code></pre>`;
    try {
      const result = language && window.hljs.getLanguage(language)
        ? window.hljs.highlight(code, { language })
        : window.hljs.highlightAuto(code);
      return `<pre><code class="hljs language-${result.language}">${result.value}</code></pre>`;
    } catch (err) {
        console.error('语法高亮失败:', err);
        return `<pre><code class="hljs">${window.DOMPurify.sanitize(code)}</code></pre>`;
    }
  };
  return window.DOMPurify.sanitize(
    window.marked.parse(markdownText, { renderer, gfm: true, breaks: true, smartLists: true, smartypants: false })
  );
};

// --- 分栏操作 ---
const createResizer = () => {
    const resizer = document.createElement('div');
    resizer.className = 'resizer';
    resizer.style.cssText = 'width: 12px; background: rgba(99, 102, 241, 0.1); position: relative; touch-action: none; cursor: col-resize; flex-shrink: 0; display: flex; align-items: center; justify-content: center;';
    const innerBar = document.createElement('div');
    innerBar.style.cssText = 'width: 4px; height: 80px; background: #6366f1; border-radius: 2px;';
    resizer.appendChild(innerBar);
    return resizer;
};
const bindResizeEvents = (resizer) => {
    resizer.addEventListener('mousedown', (e) => {
        const resizerIndex = Array.from(columnContainer.children).indexOf(resizer);
        if (resizerIndex === -1) return;
        leftColEl = columnContainer.children[resizerIndex - 1];
        rightColEl = columnContainer.children[resizerIndex + 1];
        if (!leftColEl || !rightColEl || !leftColEl.classList.contains('column') || !rightColEl.classList.contains('column')) {
            console.error('无法找到相邻的分栏');
            return;
        }
        isResizing = true;
        startX = e.clientX;
        initialLeftWidth = parseFloat(leftColEl.style.flexBasis || '0');
        initialRightWidth = parseFloat(rightColEl.style.flexBasis || '0');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
        e.stopPropagation();
    });
};
const rebuildResizers = () => {
    columnContainer.querySelectorAll('.resizer').forEach(resizer => resizer.remove());
    if (columns.length < 2) return;
    columns.forEach((col, index) => {
        if (index < columns.length - 1) {
            const resizer = createResizer();
            col.after(resizer);
            bindResizeEvents(resizer);
        }
        col.style.borderRight = index < columns.length - 1 ? '1px solid #e2e8f0' : 'none';
    });
};
const createColumnElement = (title = '', content = '', width = '') => {
  title = String(title || '');
  content = String(content || '');
  const newColumn = document.createElement('div');
  newColumn.className = 'column';
  newColumn.style.cssText = `flex: 1 1 ${width}; padding: 1px; background: #f9fafb; box-sizing: border-box; overflow: auto; display: flex; flex-direction: column;`;
  
  newColumn.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #6366f1;">
      <span class="column-title" contenteditable="true" spellcheck="false" style="min-width: 50px;">${title}</span>
      <!-- 纵向排列的操作按钮容器 -->
      <div class="action-buttons">
        <span class="drag-handle">☰</span> <!-- 拖拽手柄 -->
        <button class="delete-column-btn">✕</button> <!-- 删除按钮 -->
      </div>
    </div>
    <div class="editor-content" style="flex-grow: 1; min-height: 350px; outline: none; font-size: 15px; line-height: 1.6; color: #374151; white-space: pre-wrap; word-break: break-word; padding: 0 5px;" contenteditable="true" data-editing="false" data-markdown="${content}">${renderMarkdown(content)}</div>
  `;
  return newColumn;
};
const addNewColumn = (title = '', content = '', width = '') => {
    syncEditingContent();
    const newColCount = columns.length + 1;
    const newWidthPercent = width || `${100 / newColCount}%`;
    const widthToTakePerExistingCol = (parseFloat(newWidthPercent) / columns.length);
    columns.forEach(col => {
        const currentWidth = parseFloat(col.style.flexBasis || (100 / columns.length));
        const newWidth = currentWidth - widthToTakePerExistingCol;
        col.style.flexBasis = `${newWidth}%`;
    });
    
    // **【核心修改点】** 修正默认标题的逻辑
    // 只有当 title 存在且转换为字符串后不为空时才使用它
    const effectiveTitle = title ? String(title).trim() : '';
    const defaultTitle = effectiveTitle || `分栏 ${newColCount}`;
    
    const defaultContent = content ? String(content).trim() : `# 新分栏 ${newColCount}\n\n在这里输入你的内容，支持 **Markdown** 和代码高亮。\n\n点击分栏内容区域开始编辑。`;
    
    const newColumn = createColumnElement(defaultTitle, defaultContent, newWidthPercent);
    columnContainer.appendChild(newColumn);
    columns.push(newColumn);
    bindColumnEvents(newColumn);
    rebuildResizers();
    initDragAndDrop();
    newColumn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    saveColumnsData();
    return newColumn;
};
const deleteColumn = (columnToDelete) => {
    if (columns.length <= 1) {
        if (!confirm('确定要删除最后一个分栏吗？此操作将清除所有本地存储的分栏数据！')) return;
    } else if (!confirm('确定要删除这个分栏吗？内容将永久丢失！')) {
        return;
    }
    syncEditingContent();
    const indexToDelete = columns.indexOf(columnToDelete);
    if (indexToDelete === -1) return;
    if (sortableInstance) {
        sortableInstance.destroy();
        sortableInstance = null;
    }
    columnToDelete.remove();
    columns.splice(indexToDelete, 1);
    if (columns.length > 0) {
        const widthPercent = `${100 / columns.length}%`;
        columns.forEach(col => col.style.flexBasis = widthPercent);
    }
    rebuildResizers();
    initDragAndDrop();
    if (columns.length === 0) {
        localStorage.removeItem(`multiColumnData_${getNoteUniqueId()}`);
    } else {
        saveColumnsData();
    }
};

// ========================================================
// ==                  核心逻辑区域                       ==
// ========================================================
const initDragAndDrop = () => {
    if (sortableInstance) {
        sortableInstance.destroy();
        sortableInstance = null;
    }
    if (columns.length <= 1) return;
    try {
        sortableInstance = new window.Sortable(columnContainer, {
            animation: 150,
            handle: '.drag-handle',
            draggable: '.column',
            ghostClass: 'sortable-ghost',
            onStart: () => {
                syncEditingContent();
                container.style.userSelect = 'none';
                document.body.style.userSelect = 'none';
            },
            onEnd: () => {
                columns = Array.from(columnContainer.querySelectorAll('.column'));
                rebuildResizers();
                saveColumnsData();
                container.style.userSelect = '';
                document.body.style.userSelect = '';
            }
        });
    } catch (e) {
        console.error('SortableJS 初始化失败：', e);
        container.style.userSelect = '';
        document.body.style.userSelect = '';
    }
};

// 优化编辑模式下的光标定位
const bindColumnEvents = (columnEl) => {
    const editorContent = columnEl.querySelector('.editor-content');
    const deleteBtn = columnEl.querySelector('.delete-column-btn');
    const columnTitle = columnEl.querySelector('.column-title');

    editorContent.addEventListener('click', (e) => {
        // 如果已经处于编辑状态，不执行任何操作
        if (editorContent.dataset.editing === 'true') return;

        syncEditingContent();
        
        // 记录当前光标位置
        const selection = window.getSelection();
        let range = null;
        if (selection.rangeCount > 0) {
            range = selection.getRangeAt(0).cloneRange();
        }

        // 切换到编辑模式
        editorContent.dataset.editing = 'true';
        const markdownContent = editorContent.dataset.markdown || '';
        editorContent.innerText = markdownContent;
        
        // 尝试恢复光标位置
        if (range) {
            // 使用 setTimeout 确保 innerText 已完全渲染
            setTimeout(() => {
                selection.removeAllRanges();
                selection.addRange(range);
            }, 0);
        } else {
            // 如果没有记录到光标位置，则直接聚焦到元素末尾
            editorContent.focus();
            selection.collapse(editorContent, editorContent.childNodes.length);
        }
    });

    editorContent.addEventListener('blur', () => {
        if (editorContent.dataset.editing === 'true') {
            syncEditingContent();
        }
    });
    
    editorContent.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            editorContent.blur();
        }
    });

    deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteColumn(columnEl);
    });

    // 标题编辑后也需要保存
    columnTitle.addEventListener('blur', saveColumnsData);
    // 为标题添加键盘事件，按Enter也会失去焦点并保存
    columnTitle.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            columnTitle.blur();
        }
    });
};
// ========================================================

// --- 初始化 ---
const init = () => {
    // 主容器结构
    container.innerHTML = `
        <div style="position: relative; width: 100%; margin: 20px 0; box-sizing: border-box;">
          <div style="position: absolute; top: -20px; left: 10px; display: flex; gap: 10px; z-index: 999;">
            <button id="addColumnBtn" style="background: #6366f1; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 14px;">+ 新增分栏</button>
          </div>
          <!-- 添加保存标识元素 -->
          <div id="save-indicator">正在保存...</div>
          <div id="columnContainer" style="display: flex; width: 100%; border: 3px solid #6366f1; border-radius: 12px; overflow: hidden; height: 450px; box-sizing: border-box;">
          </div>
        </div>
    `;
    
    // 获取DOM元素引用
    columnContainer = container.querySelector('#columnContainer');
    addColumnBtn = container.querySelector('#addColumnBtn');
    saveIndicator = container.querySelector('#save-indicator');

    const savedData = loadColumnsData();
    if (savedData && savedData.length > 0) {
        savedData.forEach(data => {
            const newColumn = createColumnElement(data.title, data.content, data.width);
            columnContainer.appendChild(newColumn);
            columns.push(newColumn);
            bindColumnEvents(newColumn);
        });
        rebuildResizers();
    } else {
        addNewColumn('分栏 1', '# 这里是分栏 1 的内容\n\n支持 **Markdown** 语法！\n\n- 列表项 1\n- 列表项 2', '50%');
        addNewColumn('分栏 2', '这里是分栏 2 的内容\n\n点击分栏内容区域开始编辑，点击外部区域或按 Ctrl+Enter 完成编辑。', '50%');
    }
    
    initDragAndDrop();
    
    addColumnBtn.addEventListener('click', addNewColumn);
    
    // 窗口大小变化时，可能需要重新计算布局
    window.addEventListener('resize', () => {
        if (columns.length > 0) {
            saveColumnsData(); // 触发一次保存，确保宽度百分比正确
        }
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const containerRect = columnContainer.getBoundingClientRect();
        const mouseDelta = e.clientX - startX;
        const percentDelta = (mouseDelta / containerRect.width) * 100;
        const newLeftWidth = initialLeftWidth + percentDelta;
        const newRightWidth = initialRightWidth - percentDelta;
        const minWidth = 10; // 最小宽度百分比
        if (newLeftWidth >= minWidth && newRightWidth >= minWidth) {
            leftColEl.style.flexBasis = `${newLeftWidth}%`;
            rightColEl.style.flexBasis = `${newRightWidth}%`;
        }
    });
    
    const endResize = () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            saveColumnsData(); // 调整大小后保存
            startX = initialLeftWidth = initialRightWidth = 0;
            leftColEl = rightColEl = null;
        }
    };
    
    document.addEventListener('mouseup', endResize);
    document.addEventListener('touchend', endResize);
    document.addEventListener('blur', endResize, true);
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.column')) {
            syncEditingContent();
        }
    });
};

// 加载所有库后初始化
Promise.all(libraries.map(loadLibrary))
    .then(init)
    .catch(err => {
        console.error("初始化失败:", err);
        container.innerHTML = `<div style="color: red; padding: 20px;">加载依赖库失败，请检查网络连接或刷新页面。</div>`;
    });
```
