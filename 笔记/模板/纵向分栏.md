
```dataviewjs
// ==============================================================================
// ==                          配置与常量                                       ==
// ==============================================================================

/**
 * 需要加载的外部库列表
 */
const LIBRARIES = [
    { src: 'https://cdn.jsdelivr.net/npm/marked/marked.min.js', name: 'marked' },
    { src: 'https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js', name: 'DOMPurify' },
    { src: 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js', name: 'Sortable' },
    { src: 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js', name: 'hljs' }
];

/**
 * 调试日志配置
 */
const DEBUG_CONFIG = {
    ENABLED: true,
    LEVELS: { ERROR: 0, WARN: 1, INFO: 2, DEBUG: 3, TRACE: 4 },
    currentLevel: 4,
    COLORS: { ERROR: '#ef4444', WARN: '#f59e0b', INFO: '#3b82f6', DEBUG: '#10b981', TRACE: '#8b5cf6' }
};

/**
 * CSS 样式表
 */
const CSS_STYLES = `
  /* --- 代码高亮 --- */
  .hljs { display: block; overflow-x: auto; padding: 0.5em; color: #c9d1d9; background: #0d1117; }
  .hljs-doctag, .hljs-keyword, .hljs-meta .hljs-keyword, .hljs-template-tag, .hljs-template-variable, .hljs-type, .hljs-variable.language_ { color: #ff7300; }
  .hljs-title, .hljs-title.class_, .hljs-title.class_.inherited__, .hljs-title.function_ { color: #3fb950; }
  .hljs-attr, .hljs-attribute, .hljs-literal, .hljs-meta, .hljs-number, .hljs-operator, .hljs-variable, .hljs-selector-attr, .hljs-selector-class, .hljs-selector-id { color: #79c0ff; }
  .hljs-regexp, .hljs-string, .hljs-meta .hljs-string { color: #e3b341; }
  .hljs-built_in, .hljs-symbol { color: #f8d583; }
  .hljs-comment, .hljs-code, .hljs-formula { color: #8b949e; }
  .hljs-name, .hljs-quote, .hljs-selector-pseudo, .hljs-selector-tag { color: #d2a8ff; }
  .hljs-subst { color: #c9d1d9; }
  .hljs-section { color: #1f6feb; font-weight: bold; }
  .hljs-bullet { color: #f2cc60; }
  .hljs-emphasis { color: #c9d1d9; font-style: italic; }
  .hljs-strong { color: #c9d1d9; font-weight: bold; }

  /* --- 编辑器内容 --- */
  .editor-content > h1, .editor-content > h2, .editor-content > h3, .editor-content > h4, .editor-content > h5, .editor-content > h6, .editor-content > p, .editor-content > ul, .editor-content > ol, .editor-content > pre, .editor-content > blockquote, .editor-content > table {
    margin-top: 0 !important; margin-bottom: 0.75em !important;
  }
  .editor-content > ul li, .editor-content > ol li { margin-bottom: 0.3em !important; }
  .editor-content > pre { padding: 0.8em !important; margin-bottom: 1em !important; }

  /* --- 动作按钮组 --- */
  .action-buttons { display: flex; flex-direction: column; align-items: center; gap: 8px; }
  
  /* --- 拖拽手柄 --- */
  .drag-handle {
    cursor: grab; color: #6366f1; user-select: none; font-size: 1.4em;
    width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
    border-radius: 50%; transition: background-color 0.2s ease;
  }
  .drag-handle:hover { background-color: rgba(99, 102, 241, 0.1); }
  .drag-handle:active { cursor: grabbing; color: #4f46e5; }
  
  /* --- 删除按钮 --- */
  .delete-column-btn {
    background: transparent !important; color: #ef4444 !important; border: none !important; outline: none !important;
    cursor: pointer; font-size: 1.4em; padding: 0; user-select: none;
    width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;
    transition: color 0.2s ease;
  }
  .delete-column-btn:hover { color: #f87171 !important; }
  .delete-column-btn:active { color: #dc2626 !important; }

  /* --- 保存指示器 --- */
  #save-indicator {
    position: absolute; top: 10px; right: 20px;
    background-color: rgba(79, 70, 229, 0.8); color: white;
    padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 500;
    opacity: 0; transition: opacity 0.3s ease; pointer-events: none; z-index: 1000;
  }
  #save-indicator.visible { opacity: 1; }

  /* --- 列标题 --- */
  .column-title {
    min-width: 50px; padding: 2px 4px; border-radius: 4px;
    transition: border 0.2s ease; border: 1px solid transparent;
  }
  .column-title:hover { border-color: #e5e7eb; }
  .column-title:focus { outline: none; border: 1px solid #6366f1; background-color: #f9fafb; }
  
  /* --- 空状态 --- */
  .empty-state {
      display: flex; justify-content: center; align-items: center; height: 100%;
      color: #9ca3af; font-style: italic;
  }

  /* --- 调整大小状态 --- */
  .resizing-body * { pointer-events: none !important; }
  .resizing-body .resizer, .resizing-body .resizer * { pointer-events: auto !important; }

  /* --- 编辑模式 --- */
  .editor-content.editing {
    background-color: #ffffff !important; border: 2px solid #ef4444 !important;
    border-radius: 4px; padding: 8px !important; pointer-events: auto !important; z-index: 10 !important;
  }

  /* --- 列容器和列 --- */
  #column-container {
    display: flex; width: 100%; border: 3px solid #6366f1; border-radius: 12px;
    overflow: hidden; height: 450px; box-sizing: border-box;
  }
  .column {
    flex: 1 1; padding: 1px; background: #f9fafb; box-sizing: border-box;
    overflow: auto; display: flex; flex-direction: column; transition: all 0.3s ease;
  }
  
  /* --- 调整器 --- */
  .resizer {
    width: 12px; background: rgba(99, 102, 241, 0.1); position: relative;
    touch-action: none; cursor: col-resize; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; z-index: 10;
  }
  .resizer .inner-bar {
    width: 4px; height: 80px; background: #6366f1; border-radius: 2px;
  }
`;

// ==============================================================================
// ==                          核心组件                                         ==
// ==============================================================================

/**
 * 多栏编辑器组件
 */
class MultiColumnEditor {
    /**
     * 构造函数
     * @param {HTMLElement} container - 组件挂载的容器
     */
    constructor(container) {
        this.container = container;
        this.state = {
            columns: [],
            sortableInstance: null,
            isResizing: false,
            startX: 0,
            initialLeftWidth: 0,
            initialRightWidth: 0,
            leftColEl: null,
            rightColEl: null,
            deleteInProgress: false,
            syncInProgress: false
        };
        this.elements = { columnContainer: null, addColumnBtn: null, saveIndicator: null };
        this.loadedLibraries = new Set();
        this.globalEventListeners = new Map();
    }

    // --------------------------------------------------------------------------
    // --- 工具与日志函数 ---
    // --------------------------------------------------------------------------

    /**
     * 打印带样式的日志
     * @param {number} level - 日志级别
     * @param {string} component - 组件名称
     * @param {string} message - 日志消息
     * @param {*} [data] - 附加数据
     */
    log(level, component, message, data = {}) {
        if (!DEBUG_CONFIG.ENABLED || level > DEBUG_CONFIG.currentLevel) return;

        const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
        const levelNames = ['ERROR', 'WARN', 'INFO', 'DEBUG', 'TRACE'];
        const levelName = levelNames[level];
        const color = DEBUG_CONFIG.COLORS[levelName];

        console.log(
            `%c[${timestamp}] ${levelName} [${component}] ${message}`,
            `color: ${color}; font-weight: bold;`,
            data
        );
    }

    /**
     * 获取当前笔记的唯一ID
     * @returns {string} 唯一ID
     */
    getNoteUniqueId() {
        return dv.current().file.path.replace(/\//g, '_');
    }

    /**
     * 检查并加载单个库
     * @param {object} lib - 库配置
     * @returns {Promise<void>}
     */
    loadLibrary(lib) {
        return new Promise((resolve, reject) => {
            if (this.loadedLibraries.has(lib.name) && window[lib.name]) {
                this.log(3, 'LIB', `${lib.name} is already loaded`);
                return resolve();
            }
            this.log(2, 'LIB', `Loading ${lib.name}...`);
            const script = document.createElement('script');
            script.src = lib.src;
            script.onload = () => {
                this.loadedLibraries.add(lib.name);
                this.log(2, 'LIB', `${lib.name} loaded successfully`);
                resolve();
            };
            script.onerror = () => {
                this.log(0, 'LIB', `Failed to load ${lib.name}`);
                reject(new Error(`Failed to load ${lib.name}`));
            };
            document.head.appendChild(script);
        });
    }

    // --------------------------------------------------------------------------
    // --- DOM 操作与渲染 ---
    // --------------------------------------------------------------------------

    /**
     * 注入CSS样式
     */
    injectStyles() {
        const styleElement = document.createElement('style');
        styleElement.textContent = CSS_STYLES;
        document.head.appendChild(styleElement);
    }

    /**
     * 创建调整器DOM
     * @returns {HTMLElement} 调整器元素
     */
    createResizer() {
        const resizer = document.createElement('div');
        resizer.className = 'resizer';
        const innerBar = document.createElement('div');
        innerBar.className = 'inner-bar';
        resizer.appendChild(innerBar);
        return resizer;
    }

    /**
     * 创建列DOM元素
     * @param {object} data - 列数据
     * @returns {HTMLElement} 列元素
     */
    createColumnElement(data) {
        const column = document.createElement('div');
        column.className = 'column';
        if (data.width) column.style.flexBasis = data.width;

        const renderedContent = this.renderMarkdown(data.content || '');

        column.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #6366f1;">
              <span class="column-title" contenteditable="true" spellcheck="false">${data.title}</span>
              <div class="action-buttons">
                <span class="drag-handle">☰</span>
                <button class="delete-column-btn">✕</button>
              </div>
            </div>
            <div class="editor-content" style="flex-grow: 1; min-height: 350px; outline: none; font-size: 15px; line-height: 1.6; color: #374151; white-space: pre-wrap; word-break: break-word; padding: 0 5px;" contenteditable="true" data-markdown="${data.content || ''}">${renderedContent}</div>
        `;
        return column;
    }

    /**
     * 使用marked和DOMPurify渲染Markdown
     * @param {string} markdownText - Markdown文本
     * @returns {string} HTML字符串
     */
    renderMarkdown(markdownText = '') {
        if (!window.marked || !window.DOMPurify) {
            this.log(1, 'RENDER', 'Dependencies (marked/DOMPurify) not ready');
            return markdownText;
        }

        const renderer = new window.marked.Renderer();
        renderer.code = (code, language) => {
            if (!window.hljs) return `<pre><code>${window.DOMPurify.sanitize(code)}</code></pre>`;
            try {
                const result = language && window.hljs.getLanguage(language)
                    ? window.hljs.highlight(code, { language })
                    : window.hljs.highlightAuto(code);
                return `<pre><code class="hljs language-${result.language}">${result.value}</code></pre>`;
            } catch (err) {
                this.log(0, 'RENDER', 'Code highlight failed', { error: err.message });
                return `<pre><code class="hljs">${window.DOMPurify.sanitize(code)}</code></pre>`;
            }
        };

        return window.DOMPurify.sanitize(
            window.marked.parse(markdownText, { renderer, gfm: true, breaks: true, smartLists: true })
        );
    }

    // --------------------------------------------------------------------------
    // --- 数据持久化 ---
    // --------------------------------------------------------------------------

    /**
     * 从localStorage加载列数据
     * @returns {object[]|null} 列数据数组
     */
    loadColumnsData() {
        try {
            const data = localStorage.getItem(`multiColumnData_${this.getNoteUniqueId()}`);
            if (!data) {
                this.log(2, 'DATA', 'No saved data found');
                return null;
            }
            const parsedData = JSON.parse(data);
            this.log(2, 'DATA', `Loaded ${parsedData.length} columns`, parsedData);
            return parsedData;
        } catch (e) {
            this.log(0, 'DATA', 'Failed to load data', { error: e.message });
            localStorage.removeItem(`multiColumnData_${this.getNoteUniqueId()}`);
            return null;
        }
    }

    /**
     * 将列数据保存到localStorage
     */
    saveColumnsData() {
        this.log(2, 'DATA', 'Saving columns data');
        this.elements.saveIndicator?.classList.add('visible');

        requestAnimationFrame(() => {
            try {
                const currentColumns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
                const data = currentColumns.map((col, index) => ({
                    title: col.querySelector('.column-title').innerText.trim() || `分栏 ${index + 1}`,
                    content: col.querySelector('.editor-content').dataset.markdown || '',
                    width: col.style.flexBasis || `${100 / currentColumns.length}%`
                }));
                localStorage.setItem(`multiColumnData_${this.getNoteUniqueId()}`, JSON.stringify(data));
                this.log(2, 'DATA', `Saved ${data.length} columns`);
            } catch (e) {
                this.log(0, 'DATA', 'Failed to save data', { error: e.message });
            } finally {
                setTimeout(() => this.elements.saveIndicator?.classList.remove('visible'), 300);
            }
        });
    }

    // --------------------------------------------------------------------------
    // --- 事件处理 ---
    // --------------------------------------------------------------------------

    /**
     * 绑定所有必要的事件监听器
     */
    bindEvents() {
        this.bindGlobalClickHandler();
        this.bindAddColumnButton();
        // 列相关的事件使用事件委托
        this.elements.columnContainer.addEventListener('click', (e) => this.handleColumnContainerClick(e));
        this.elements.columnContainer.addEventListener('mousedown', (e) => this.handleColumnContainerMouseDown(e));
        this.elements.columnContainer.addEventListener('blur', (e) => this.handleColumnContainerBlur(e), true);
        this.elements.columnContainer.addEventListener('keydown', (e) => this.handleColumnContainerKeydown(e));
    }

    /**
     * 设置全局点击处理器，用于在点击外部时同步内容
     */
    bindGlobalClickHandler() {
        const handler = (e) => {
            if (!this.elements.columnContainer.contains(e.target)) {
                this.syncEditingContent();
            }
        };
        document.addEventListener('click', handler);
        this.globalEventListeners.set('document:click', handler);
    }

    /**
     * 绑定新增列按钮事件
     */
    bindAddColumnButton() {
        this.elements.addColumnBtn.addEventListener('click', () => this.addNewColumn());
    }

    /**
     * 处理列容器内的点击事件（事件委托）
     * @param {MouseEvent} e - 鼠标事件
     */
    handleColumnContainerClick(e) {
        const deleteBtn = e.target.closest('.delete-column-btn');
        if (deleteBtn) {
            e.preventDefault();
            e.stopPropagation();
            const column = deleteBtn.closest('.column');
            if (column) this.deleteColumn(column);
        }
    }

    /**
     * 处理列容器内的鼠标按下事件（事件委托）
     * @param {MouseEvent} e - 鼠标事件
     */
    handleColumnContainerMouseDown(e) {
        const resizer = e.target.closest('.resizer');
        if (resizer) {
            this.startResize(e, resizer);
            return;
        }

        const editorContent = e.target.closest('.editor-content');
        if (editorContent && !editorContent.classList.contains('editing')) {
            this.syncEditingContent(); // 同步其他正在编辑的列
            this.enterEditMode(editorContent);
        }
    }

    /**
     * 处理列容器内的失去焦点事件（事件委托）
     * @param {FocusEvent} e - 焦点事件
     */
    handleColumnContainerBlur(e) {
        if (e.target.classList.contains('editor-content') && e.target.classList.contains('editing')) {
            this.exitEditMode(e.target);
        } else if (e.target.classList.contains('column-title')) {
            const column = e.target.closest('.column');
            if (column) this.saveColumnsData();
        }
    }

    /**
     * 处理列容器内的键盘事件（事件委托）
     * @param {KeyboardEvent} e - 键盘事件
     */
    handleColumnContainerKeydown(e) {
        if (e.target.classList.contains('editor-content') && e.target.classList.contains('editing')) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            }
        } else if (e.target.classList.contains('column-title') && (e.key === 'Enter' || e.key === 'Escape')) {
            e.preventDefault();
            e.target.blur();
        }
    }

    // --------------------------------------------------------------------------
    // --- 核心功能 ---
    // --------------------------------------------------------------------------

    /**
     * 进入编辑模式
     * @param {HTMLElement} editorEl - 编辑器元素
     */
    enterEditMode(editorEl) {
        this.log(3, 'EDIT', 'Entering edit mode');
        const markdownContent = editorEl.dataset.markdown || '';
        editorEl.innerText = markdownContent;
        editorEl.classList.add('editing');
        setTimeout(() => {
            editorEl.focus({ preventScroll: true });
            const range = document.createRange();
            range.selectNodeContents(editorEl);
            range.collapse(false);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }, 0);
    }

    /**
     * 退出编辑模式并同步内容
     * @param {HTMLElement} editorEl - 编辑器元素
     */
    exitEditMode(editorEl) {
        this.log(3, 'EDIT', 'Exiting edit mode');
        if (this.state.syncInProgress) return;
        this.state.syncInProgress = true;

        const cleanedContent = editorEl.innerText.replace(/\n{3,}/g, '\n\n');
        editorEl.dataset.markdown = cleanedContent;
        editorEl.classList.remove('editing');
        editorEl.innerHTML = this.renderMarkdown(cleanedContent);

        this.saveColumnsData();
        this.state.syncInProgress = false;
    }

    /**
     * 同步所有正在编辑的内容
     */
    syncEditingContent() {
        const editingEditors = this.elements.columnContainer.querySelectorAll('.editor-content.editing');
        editingEditors.forEach(editor => this.exitEditMode(editor));
    }

    /**
     * 开始调整列大小
     * @param {MouseEvent} e - 鼠标事件
     * @param {HTMLElement} resizer - 调整器元素
     */
    startResize(e, resizer) {
        this.log(3, 'RESIZE', 'Starting resize');
        if (this.state.isResizing) return;

        const resizerIndex = Array.from(this.elements.columnContainer.children).indexOf(resizer);
        this.state.leftColEl = this.elements.columnContainer.children[resizerIndex - 1];
        this.state.rightColEl = this.elements.columnContainer.children[resizerIndex + 1];

        if (!this.state.leftColEl || !this.state.rightColEl || !this.state.leftColEl.classList.contains('column')) return;

        this.state.isResizing = true;
        this.state.startX = e.clientX;
        this.state.initialLeftWidth = parseFloat(this.state.leftColEl.style.flexBasis || (100 / this.state.columns.length));
        this.state.initialRightWidth = parseFloat(this.state.rightColEl.style.flexBasis || (100 / this.state.columns.length));

        document.body.classList.add('resizing-body');
        document.addEventListener('mousemove', (e) => this.doResize(e));
        document.addEventListener('mouseup', () => this.endResize());
        document.addEventListener('mouseleave', () => this.endResize());

        e.preventDefault();
        e.stopPropagation();
    }

    /**
     * 执行调整大小
     * @param {MouseEvent} e - 鼠标事件
     */
    doResize(e) {
        if (!this.state.isResizing) return;

        const containerRect = this.elements.columnContainer.getBoundingClientRect();
        const mouseDelta = e.clientX - this.state.startX;
        const percentDelta = (mouseDelta / containerRect.width) * 100;

        const newLeftWidth = this.state.initialLeftWidth + percentDelta;
        const newRightWidth = this.state.initialRightWidth - percentDelta;
        const minWidth = 10;

        if (newLeftWidth >= minWidth && newRightWidth >= minWidth) {
            this.state.leftColEl.style.flexBasis = `${newLeftWidth}%`;
            this.state.rightColEl.style.flexBasis = `${newRightWidth}%`;
        }
        e.preventDefault();
    }

    /**
     * 结束调整大小
     */
    endResize() {
        this.log(3, 'RESIZE', 'Ending resize');
        if (!this.state.isResizing) return;

        this.state.isResizing = false;
        document.body.classList.remove('resizing-body');
        document.removeEventListener('mousemove', (e) => this.doResize(e));
        document.removeEventListener('mouseup', () => this.endResize());
        document.removeEventListener('mouseleave', () => this.endResize());

        this.saveColumnsData();
        this.state.leftColEl = null;
        this.state.rightColEl = null;
    }

    /**
     * 重建所有调整器
     */
    rebuildResizers() {
        this.log(2, 'LAYOUT', 'Rebuilding resizers');
        // 移除旧的
        this.elements.columnContainer.querySelectorAll('.resizer').forEach(resizer => resizer.remove());

        const columns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
        if (columns.length < 2) return;

        // 添加新的
        columns.forEach((col, index) => {
            if (index < columns.length - 1) {
                const resizer = this.createResizer();
                col.after(resizer);
            }
        });
    }

    /**
     * 初始化拖拽排序
     */
    initDragAndDrop() {
        this.log(2, 'DRAG', 'Initializing drag and drop');
        if (this.state.sortableInstance) {
            this.state.sortableInstance.destroy();
        }

        const columns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
        if (columns.length <= 1) return;

        try {
            this.state.sortableInstance = new window.Sortable(this.elements.columnContainer, {
                animation: 150,
                handle: '.drag-handle',
                draggable: '.column',
                ghostClass: 'sortable-ghost',
                onStart: () => {
                    this.syncEditingContent();
                    document.body.style.userSelect = 'none';
                },
                onEnd: () => {
                    document.body.style.userSelect = '';
                    this.rebuildResizers();
                    this.saveColumnsData();
                }
            });
        } catch (e) {
            this.log(0, 'DRAG', 'Failed to initialize Sortable', { error: e.message });
        }
    }

    /**
     * 添加新列
     * @param {object} [data] - 列数据
     */
    addNewColumn(data = {}) {
        this.log(2, 'COLUMN', 'Adding new column');
        this.endResize(); // 如果正在调整大小，则结束

        const columns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
        const newColCount = columns.length + 1;
        const newWidthPercent = `${100 / newColCount}%`;

        // 调整现有列的宽度
        columns.forEach(col => {
            col.style.flexBasis = newWidthPercent;
        });

        // 准备新列数据
        const newColumnData = {
            title: data.title || `分栏 ${newColCount}`,
            content: data.content || `# 新分栏 ${newColCount}\n\n在这里输入你的内容，支持 **Markdown** 和代码高亮。\n\n点击分栏内容区域开始编辑。`,
            width: newWidthPercent
        };

        const newColumn = this.createColumnElement(newColumnData);
        this.elements.columnContainer.appendChild(newColumn);

        this.rebuildResizers();
        this.initDragAndDrop();
        this.saveColumnsData();

        // 自动聚焦到新列
        setTimeout(() => {
            const editor = newColumn.querySelector('.editor-content');
            if (editor) {
                const event = new MouseEvent('mousedown', { bubbles: true });
                editor.dispatchEvent(event);
            }
        }, 100);
    }

    /**
     * 删除列
     * @param {HTMLElement} column - 要删除的列元素
     */
    deleteColumn(column) {
        this.log(2, 'COLUMN', 'Deleting column');
        if (this.state.deleteInProgress) return;
        this.state.deleteInProgress = true;

        const columnTitle = column.querySelector('.column-title').innerText;
        const columns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
        
        let confirmMessage = `确定要删除分栏 "${columnTitle}" 吗？内容将永久丢失！`;
        if (columns.length <= 1) {
            confirmMessage = '确定要删除最后一个分栏吗？此操作将清除所有本地存储的分栏数据！';
        }

        if (!confirm(confirmMessage)) {
            this.state.deleteInProgress = false;
            return;
        }

        // 确保该列已退出编辑模式
        const editor = column.querySelector('.editor-content');
        if (editor && editor.classList.contains('editing')) {
            this.exitEditMode(editor);
        }
        
        column.remove();

        const remainingColumns = Array.from(this.elements.columnContainer.querySelectorAll('.column'));
        if (remainingColumns.length === 0) {
            this.elements.columnContainer.innerHTML = '<div class="empty-state">没有分栏，请点击上方 "+ 新增分栏" 按钮创建</div>';
            localStorage.removeItem(`multiColumnData_${this.getNoteUniqueId()}`);
        } else {
            const newWidthPercent = `${100 / remainingColumns.length}%`;
            remainingColumns.forEach(col => {
                col.style.flexBasis = newWidthPercent;
            });
            this.rebuildResizers();
            this.initDragAndDrop();
            this.saveColumnsData();
        }

        this.state.deleteInProgress = false;
    }

    // --------------------------------------------------------------------------
    // --- 初始化与销毁 ---
    // --------------------------------------------------------------------------

    /**
     * 渲染组件UI
     */
    render() {
        this.container.innerHTML = `
            <div style="position: relative; width: 100%; margin: 20px 0; box-sizing: border-box;">
                <div style="position: absolute; top: -20px; left: 10px; display: flex; gap: 10px; z-index: 999;">
                    <button id="add-column-btn" style="background: #6366f1; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 14px;">+ 新增分栏</button>
                </div>
                <div id="save-indicator">正在保存...</div>
                <div id="column-container"></div>
            </div>
        `;

        this.elements.columnContainer = this.container.querySelector('#column-container');
        this.elements.addColumnBtn = this.container.querySelector('#add-column-btn');
        this.elements.saveIndicator = this.container.querySelector('#save-indicator');
    }

    /**
     * 初始化组件
     */
    async init() {
        this.log(2, 'INIT', 'Initializing Multi-Column Editor');
        try {
            this.injectStyles();
            this.render();
            await Promise.all(LIBRARIES.map(lib => this.loadLibrary(lib)));
            
            const savedData = this.loadColumnsData();
            if (savedData && savedData.length > 0) {
                // 批量添加从本地存储加载的列
                savedData.forEach(data => {
                    const column = this.createColumnElement(data);
                    this.elements.columnContainer.appendChild(column);
                });
                this.rebuildResizers();
            } else {
                // 添加默认列
                this.addNewColumn({ title: '分栏 1', content: '# 分栏 1\n\n默认内容', width: '100%' });
            }
            
            this.bindEvents();
            this.initDragAndDrop();

        } catch (error) {
            this.log(0, 'INIT', 'Initialization failed', { error: error.message });
            this.container.innerHTML = `<div style="color: red; padding: 20px;">组件初始化失败: ${error.message}</div>`;
        }
    }

    /**
     * 销毁组件，清理事件和DOM
     */
    destroy() {
        this.log(2, 'DESTROY', 'Destroying component');
        
        // 解绑全局事件
        this.globalEventListeners.forEach((handler, key) => {
            const [target, event] = key.split(':');
            if (target === 'document') {
                document.removeEventListener(event, handler);
            }
        });
        this.globalEventListeners.clear();

        // 销毁拖拽实例
        if (this.state.sortableInstance) {
            this.state.sortableInstance.destroy();
        }
        
        // 清空容器
        if (this.container) {
            this.container.innerHTML = '';
        }
    }
}

// ==============================================================================
// ==                          入口点                                           ==
// ==============================================================================

// 确保在 dv 对象存在的环境中运行 (Obsidian DataView)
if (typeof dv !== 'undefined') {
    const editor = new MultiColumnEditor(dv.container);
    editor.init();

    // 导出销毁函数供 Obsidian 插件系统调用，以防止内存泄漏
    module.exports = {
        destroy: () => editor.destroy()
    };
}
```
