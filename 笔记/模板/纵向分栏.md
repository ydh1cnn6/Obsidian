```dataviewjs
// 1. 动态引入所需库
const libraries = [
    { src: 'https://cdn.jsdelivr.net/npm/marked/marked.min.js', name: 'marked' },
    { src: 'https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js', name: 'DOMPurify' },
    { src: 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js', name: 'Sortable' },
    { src: 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js', name: 'hljs' }
];

const loadedLibraries = new Set();
// 完整实现：加载单个库的函数
const loadLibrary = (lib) => {
    return new Promise((resolve, reject) => {
        if (loadedLibraries.has(lib.name) && window[lib.name]) {
            return resolve();
        }
        const script = document.createElement('script');
        script.src = lib.src;
        script.onload = () => {
            loadedLibraries.add(lib.name);
            resolve();
        };
        script.onerror = () => reject(new Error(`Failed to load ${lib.name}`));
        document.head.appendChild(script);
    });
};

// --- 内嵌 highlight.js 样式表 ---
const highlightStyle = document.createElement('style');
highlightStyle.textContent = `/* github-dark theme */
.hljs { display: block; overflow-x: auto; padding: 0.5em; color: #c9d1d9; background: #0d1117; }
.hljs-doctag, .hljs-keyword, .hljs-meta .hljs-keyword, .hljs-template-tag, .hljs-template-variable, .hljs-type, .hljs-variable.language_ { color: #ff7300; }
.hljs-title, .hljs-title.class_, .hljs-title.class_.inherited__, .hljs-title.function_ { color: #3fb950; }
.hljs-attr, .hljs-attribute, .hljs-literal, .hljs-meta, .hljs-number, .hljs-operator, .hljs-variable, .hljs-selector-attr, .hljs-selector-class, .hljs-selector-id { color: #79c0ff; }
.hljs-regexp, .hljs-string, .hljs-meta .hljs-string { color: #e3b341; }
.hljs-built_in, .hljs-symbol { color: #f8d583; }
.hljs-comment, .hljs-code, .hljs-formula { color: #8b949e; }
.hljs-name, .hljs-quote, .hljs-selector-pseudo, .hljs-selector-tag { color: #d2a8ff; }
.hljs-subst { color: #c9d1d9; }
.hljs-section { color: #1f6feb; font-weight: bold; }
.hljs-bullet { color: #f2cc60; }
.hljs-emphasis { color: #c9d1d9; font-style: italic; }
.hljs-strong { color: #c9d1d9; font-weight: bold; }

/* 标题编辑时显示边框 */
.column-title {
    padding: 2px 4px;
    border-radius: 4px;
    transition: border 0.2s ease;
}
.column-title:focus {
    outline: none; /* 移除默认的轮廓 */
    border: 2px solid #9ca3af; /* 改为灰色边框 */
    box-shadow: 0 0 5px rgba(156, 163, 175, 0.5); /* 改为灰色阴影效果 */
}
`;
document.head.appendChild(highlightStyle);
// --- 修改结束 ---

// --- 新增：重置 Markdown 元素默认边距（解决第一行上空白问题）---
const markdownStyleReset = document.createElement('style');
markdownStyleReset.textContent = `
  /* 重置 Markdown 渲染后元素的默认边距，消除第一行上方空白 */
  .editor-content > h1,
  .editor-content > h2,
  .editor-content > h3,
  .editor-content > h4,
  .editor-content > h5,
  .editor-content > h6,
  .editor-content > p,
  .editor-content > ul,
  .editor-content > ol,
  .editor-content > pre,
  .editor-content > blockquote,
  .editor-content > table {
    margin-top: 0 !important; /* 取消上外边距 */
    margin-bottom: 0.75em !important; /* 保留合理的下外边距，保证段落间距 */
  }
  /* 列表项内部间距调整 */
  .editor-content > ul li,
  .editor-content > ol li {
    margin-bottom: 0.3em !important;
  }
  /* 代码块样式微调（避免与其他元素间距冲突） */
  .editor-content > pre {
    padding: 0.8em !important;
    margin-bottom: 1em !important;
  }
`;
document.head.appendChild(markdownStyleReset);
// --- 新增结束 ---

// 2. 全局状态和 DOM 元素
let columns = [];
let sortableInstance = null;
const container = dv.container;
let columnContainer, addColumnBtn;
let isDragAndDropActive = false;

// 3. 数据持久化
const getNoteUniqueId = () => dv.current().file.path.replace(/\//g, '_');

// 优化：异步保存数据
const saveColumnsData = () => {
    requestAnimationFrame(() => {
        try {
            syncEditingContent();
            const data = columns.map((col, index) => ({
                title: col.querySelector('.column-title').innerText.trim() || `分栏 ${index + 1}`,
                content: col.querySelector('.editor-content').dataset.markdown || '',
                width: col.style.flexBasis || `${100 / columns.length}%`
            }));
            localStorage.setItem(`multiColumnData_${getNoteUniqueId()}`, JSON.stringify(data));
        } catch (e) {
            console.error('分栏数据保存失败：', e);
        }
    });
};

// 完整实现：加载分栏数据
const loadColumnsData = () => {
    try {
        const data = localStorage.getItem(`multiColumnData_${getNoteUniqueId()}`);
        return data ? JSON.parse(data) : null;
    } catch (e) {
        console.error('分栏数据读取失败：', e);
        localStorage.removeItem(`multiColumnData_${getNoteUniqueId()}`);
        return null;
    }
};

// 4. 核心渲染和事件处理
const syncEditingContent = () => {
  columns.forEach(col => {
    const editor = col.querySelector('.editor-content');
    if (editor.dataset.editing === 'true') {
      const cleanedContent = editor.innerText.replace(/\n{3,}/g, '\n\n');
      editor.dataset.markdown = cleanedContent;
      editor.dataset.editing = 'false';
      editor.innerHTML = renderMarkdown(cleanedContent);
    }
  });
};

const renderMarkdown = (markdownText = '') => {
  markdownText = String(markdownText || '');
  if (!window.marked || !window.DOMPurify) {
    console.warn('依赖库尚未加载完成，无法渲染Markdown。');
    return markdownText;
  }
  const renderer = new window.marked.Renderer();
  
  renderer.code = function(code, language) {
    code = String(code || '');
    if (!window.hljs) return `<pre><code>${window.DOMPurify.sanitize(code)}</code></pre>`;
    try {
      const result = language && window.hljs.getLanguage(language)
        ? window.hljs.highlight(code, { language })
        : window.hljs.highlightAuto(code);
      return `<pre><code class="hljs language-${result.language}">${result.value}</code></pre>`;
    } catch (err) {
      console.error('语法高亮失败:', err);
      return `<pre><code class="hljs">${window.DOMPurify.sanitize(code)}</code></pre>`;
    }
  };

  return window.DOMPurify.sanitize(
    window.marked.parse(markdownText, { 
      renderer, 
      gfm: true,
      breaks: true,
      smartLists: true,
      smartypants: false
    })
  );
};

const initDragAndDrop = () => {
    // 先销毁已存在的实例，避免重复创建
    if (sortableInstance) {
        sortableInstance.destroy();
        sortableInstance = null;
        isDragAndDropActive = false;
    }
    if (columns.length <= 1) return;
    
    try {
        sortableInstance = new window.Sortable(columnContainer, {
            animation: 150,
            handle: '.column-title',
            draggable: '.column',
            ghostClass: 'sortable-ghost',
            onStart: () => {
                syncEditingContent();
                container.style.userSelect = 'none';
            },
            onEnd: () => {
                columns = Array.from(columnContainer.querySelectorAll('.column'));
                rebuildResizers();
                saveColumnsData();
                container.style.userSelect = '';
            }
        });
        isDragAndDropActive = true;
    } catch (e) {
        console.error('SortableJS 初始化失败：', e);
    }
};

// --- 分栏操作 ---
const createResizer = () => {
    const resizer = document.createElement('div');
    resizer.className = 'resizer';
    resizer.style.cssText = 'width: 12px; background: rgba(99, 102, 241, 0.1); position: relative; touch-action: none; cursor: col-resize; flex-shrink: 0; display: flex; align-items: center; justify-content: center;';
    const innerBar = document.createElement('div');
    innerBar.style.cssText = 'width: 4px; height: 80px; background: #6366f1; border-radius: 2px;';
    resizer.appendChild(innerBar);
    return resizer;
};

let isResizing = false; 
let startX, initialLeftWidth, initialRightWidth, leftColEl, rightColEl;

const bindResizeEvents = (resizer) => {
    resizer.addEventListener('mousedown', (e) => {
        const resizerIndex = Array.from(columnContainer.children).indexOf(resizer);
        if (resizerIndex === -1) return;

        leftColEl = columnContainer.children[resizerIndex - 1];
        rightColEl = columnContainer.children[resizerIndex + 1];

        if (!leftColEl || !rightColEl || !leftColEl.classList.contains('column') || !rightColEl.classList.contains('column')) {
            console.error('无法找到相邻的分栏');
            return;
        }
        
        isResizing = true;
        startX = e.clientX;
        initialLeftWidth = parseFloat(leftColEl.style.flexBasis || '0');
        initialRightWidth = parseFloat(rightColEl.style.flexBasis || '0');

        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        
        e.preventDefault();
        e.stopPropagation();
    });
};

const rebuildResizers = () => {
    columnContainer.querySelectorAll('.resizer').forEach(resizer => resizer.remove());
    if (columns.length < 2) return;
    columns.forEach((col, index) => {
        if (index < columns.length - 1) {
            const resizer = createResizer();
            col.after(resizer);
            bindResizeEvents(resizer);
        }
        col.style.borderRight = index < columns.length - 1 ? '1px solid #e2e8f0' : 'none';
    });
};

const createColumnElement = (title = '', content = '', width = '') => {
  title = String(title || '');
  content = String(content || '');
  const newColumn = document.createElement('div');
  newColumn.className = 'column';
  newColumn.style.cssText = `flex: 1 1 ${width}; padding: 1px; background: #f9fafb; box-sizing: border-box; overflow: auto; display: flex; flex-direction: column;`;
  
  newColumn.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #6366f1;">
      <span class="column-title" contenteditable="true" spellcheck="false">${title}</span>
      <button class="delete-column-btn" style="background: transparent; color: #ef4444; border: none; cursor: pointer; font-size: 16px; padding: 0 5px;">✕</button>
    </div>
    <div class="editor-content" style="flex-grow: 1; min-height: 350px; outline: none; font-size: 15px; line-height: 1; color: #374151; white-space: pre-wrap; word-break: break-word; padding: 0 5px;" contenteditable="true" data-editing="false" data-markdown="${content}">${renderMarkdown(content)}</div>
  `;
  return newColumn;
};

const addNewColumn = (title = '', content = '', width = '') => {
    syncEditingContent();
    
    const newColCount = columns.length + 1;
    const newWidthPercent = width || `${100 / newColCount}%`;

    const widthToTakePerExistingCol = (parseFloat(newWidthPercent) / columns.length);
    columns.forEach(col => {
        const currentWidth = parseFloat(col.style.flexBasis || (100 / columns.length));
        const newWidth = currentWidth - widthToTakePerExistingCol;
        col.style.flexBasis = `${newWidth}%`;
    });

    const defaultTitle = String(title).trim() || `分栏 ${newColCount}`;
    const defaultContent = String(content).trim() || `# 新分栏 ${newColCount}\n\n在这里输入你的内容，支持 **Markdown** 和代码高亮。`;
    
    const newColumn = createColumnElement(defaultTitle, defaultContent, newWidthPercent);
    columnContainer.appendChild(newColumn);
    
    columns.push(newColumn);
    bindColumnEvents(newColumn);
    
    rebuildResizers();
    initDragAndDrop(); // 新增后初始化拖拽
    
    newColumn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    saveColumnsData();
    
    return newColumn;
};

// 修复核心：删除分栏时先销毁Sortable实例，避免事件残留
const deleteColumn = (columnToDelete) => {
    if (columns.length <= 1) {
        if (!confirm('确定要删除最后一个分栏吗？此操作将清除所有本地存储的分栏数据！')) return;
    } else if (!confirm('确定要删除这个分栏吗？内容将永久丢失！')) {
        return;
    }
    
    syncEditingContent();
    const indexToDelete = columns.indexOf(columnToDelete);
    if (indexToDelete === -1) return;

    // 关键修复：删除前先销毁拖拽实例，避免引用已删除元素导致冲突
    if (sortableInstance) {
        sortableInstance.destroy();
        sortableInstance = null;
        isDragAndDropActive = false;
    }

    // 执行删除操作
    columnToDelete.remove();
    columns.splice(indexToDelete, 1);
    
    // 调整剩余分栏宽度
    if (columns.length > 0) {
        const widthPercent = `${100 / columns.length}%`;
        columns.forEach(col => col.style.flexBasis = widthPercent);
    }
    
    rebuildResizers();
    initDragAndDrop(); // 删除后重新初始化拖拽（若分栏数>1）

    // 清理数据
    if (columns.length === 0) {
        localStorage.removeItem(`multiColumnData_${getNoteUniqueId()}`);
    } else {
        saveColumnsData();
    }
};

const bindColumnEvents = (columnEl) => {
    const editorContent = columnEl.querySelector('.editor-content');
    const deleteBtn = columnEl.querySelector('.delete-column-btn');
    const columnTitle = columnEl.querySelector('.column-title');

    columnTitle.addEventListener('click', (e) => {
        e.stopPropagation();
        editorContent.dataset.editing = 'true';
        editorContent.innerText = editorContent.dataset.markdown || '';
        editorContent.focus();
    });

    editorContent.addEventListener('click', () => {
        if (editorContent.dataset.editing !== 'true') {
            editorContent.dataset.editing = 'true';
            editorContent.innerText = editorContent.dataset.markdown || '';
        }
    });

    editorContent.addEventListener('blur', () => {
        if (editorContent.dataset.editing === 'true') {
            syncEditingContent();
        }
    });

    editorContent.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            editorContent.blur();
        }
    });

    deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteColumn(columnEl);
    });
};

// --- 初始化 ---
const init = () => {
    // 渲染主 HTML 结构
    container.innerHTML = `
        <div style="position: relative; width: 100%; margin: 20px 0; box-sizing: border-box;">
          <div style="position: absolute; top: -20px; left: 10px; display: flex; gap: 10px; z-index: 999;">
            <button id="addColumnBtn" style="background: #6366f1; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 14px;">+ 新增分栏</button>
          </div>
          <div id="columnContainer" style="display: flex; width: 100%; border: 3px solid #6366f1; border-radius: 12px; overflow: hidden; height: 450px; box-sizing: border-box;">
            <!-- 初始分栏将通过JS动态添加 -->
          </div>
        </div>
    `;

    // 获取 DOM 引用
    columnContainer = container.querySelector('#columnContainer');
    addColumnBtn = container.querySelector('#addColumnBtn');

    // 加载数据
    const savedData = loadColumnsData();
    if (savedData && savedData.length > 0) {
        savedData.forEach(data => {
            const newColumn = createColumnElement(data.title, data.content, data.width);
            columnContainer.appendChild(newColumn);
            columns.push(newColumn);
            bindColumnEvents(newColumn);
        });
        rebuildResizers();
    } else {
        // 添加默认的两个分栏
        addNewColumn('分栏 1', '# 这里是分栏 1 的内容\n\n支持 **Markdown** 语法！\n\n- 列表项 1\n- 列表项 2', '50%');
        addNewColumn('分栏 2', '这里是分栏 2 的内容\n\n点击编辑器区域开始编辑，点击外部区域或按 Ctrl+Enter 完成编辑。', '50%');
    }
    
    initDragAndDrop();
    
    // 绑定全局事件
    addColumnBtn.addEventListener('click', addNewColumn);

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const containerRect = columnContainer.getBoundingClientRect();
        const mouseDelta = e.clientX - startX;
        const percentDelta = (mouseDelta / containerRect.width) * 100;

        const newLeftWidth = initialLeftWidth + percentDelta;
        const newRightWidth = initialRightWidth - percentDelta;
        const minWidth = 10;

        if (newLeftWidth >= minWidth && newRightWidth >= minWidth) {
            leftColEl.style.flexBasis = `${newLeftWidth}%`;
            rightColEl.style.flexBasis = `${newRightWidth}%`;
        }
    });

    const endResize = () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            saveColumnsData();
            startX = initialLeftWidth = initialRightWidth = 0;
            leftColEl = rightColEl = null;
        }
    };

    document.addEventListener('mouseup', endResize);
    document.addEventListener('touchend', endResize);
    document.addEventListener('blur', endResize, true);

    // 点击页面空白处，结束所有编辑
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.editor-content') && !e.target.closest('.column-title')) {
            columns.forEach(col => {
                const editor = col.querySelector('.editor-content');
                if (editor.dataset.editing === 'true') {
                    editor.blur();
                }
            });
        }
    });
};

// 加载所有库后初始化
Promise.all(libraries.map(loadLibrary))
    .then(init)
    .catch(err => {
        console.error("初始化失败:", err);
        container.innerHTML = `<div style="color: red; padding: 20px;">加载依赖库失败，请检查网络连接或刷新页面。</div>`;
    });

```

