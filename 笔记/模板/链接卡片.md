<%*
// ========== 核心配置（可自定义） ==========
// 1. 预设卡片样式数据（可新增/修改）
const cardData = [
  {
    id: 0,
    defaultHref: "https://example.com",
    imgSrc: "https://bkimg.cdn.bcebos.com/pic/dbb44aed2e738bd4eea32ffaad8b87d6267ff97f?x-bce-process=image/format,f_auto/quality,Q_70/resize,m_lfit,limit_1,w_536",
    text: "CSDN"
  },
  {
    id: 1,
    defaultHref: "https://example.com/tencent",
    imgSrc: "https://cloudcache.tencent-cloud.com/qcloud/portal/kit/images/slice/logo.23996906.svg",
    text: "腾讯云"
  },
  {
    id: 2,
    defaultHref: "https://example.com/feiniu",
    imgSrc: "https://static2.fnnas.com/official/fnos-logo.png",
    text: "飞牛云"
  },
  {
    id: 3,
    defaultHref: "https://example.com/feiniu2",
    imgSrc: "https://pica.zhimg.com/v2-4cd83ae3d6ca76dabecf001244a62310.jpg?source=57bbeac9",
    text: "知乎"
  },
  {
    id: 4,
    defaultHref: "https://example.com/feiniu3",
    imgSrc: "https://i0.hdslb.com/bfs/activity-plat/cover/20170614/x65z8xpm2z.png",
    text: "B站"
  }
];

// 2. 获取当前光标位置（核心：在光标处插入内容）
const cursorPos = tp.editor.getCursor();

// ========== 交互式弹窗逻辑（保留原选择/输入功能） ==========
// 构建弹窗HTML（模拟原选择器+输入框）
async function showCardGeneratorDialog() {
  // 1. 创建临时弹窗容器
  const dialogContainer = document.createElement("div");
  dialogContainer.style.cssText = `
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 9999; width: 400px;
  `;

  // 2. 构建交互元素（下拉选择器+输入框+按钮）
  dialogContainer.innerHTML = `
    <div style="margin-bottom: 12px; font-weight: 600; font-size: 16px;">生成卡片链接</div>
    <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
      <select id="cardSelector" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">选择卡片样式</option>
        ${cardData.map(card => `<option value="${card.id}">${card.text}</option>`).join('')}
      </select>
      <input id="hrefInput" type="text" placeholder="输入链接地址" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
      <input id="textInput" type="text" placeholder="输入显示文字" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div style="display: flex; gap: 8px; justify-content: flex-end;">
      <button id="cancelBtn" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">取消</button>
      <button id="submitBtn" style="padding: 6px 12px; background: #2eaadc; color: white; border: none; border-radius: 4px; cursor: pointer;">生成</button>
    </div>
  `;
  document.body.appendChild(dialogContainer);

  // 3. 获取弹窗元素
  const selector = dialogContainer.querySelector("#cardSelector");
  const hrefInput = dialogContainer.querySelector("#hrefInput");
  const textInput = dialogContainer.querySelector("#textInput");
  const submitBtn = dialogContainer.querySelector("#submitBtn");
  const cancelBtn = dialogContainer.querySelector("#cancelBtn");

  // 4. 选择样式时填充默认值
  selector.addEventListener("change", (e) => {
    const selectedId = e.target.value;
    if (selectedId) {
      const selectedCard = cardData.find(card => card.id === parseInt(selectedId));
      hrefInput.value = selectedCard.defaultHref;
      textInput.value = selectedCard.text;
    } else {
      hrefInput.value = "";
      textInput.value = "";
    }
  });

  // 5. 封装关闭弹窗方法
  const closeDialog = () => {
    document.body.removeChild(dialogContainer);
  };

  // 6. 返回Promise，等待用户操作
  return new Promise((resolve) => {
    // 取消按钮
    cancelBtn.addEventListener("click", () => {
      closeDialog();
      resolve(null);
    });

    // 生成按钮
    submitBtn.addEventListener("click", () => {
      const selectedId = selector.value;
      const customHref = hrefInput.value.trim();
      const customText = textInput.value.trim();

      // 校验
      if (!selectedId) {
        new Notice("请选择卡片样式！");
        return;
      }
      if (!customHref) {
        new Notice("请输入链接地址！");
        return;
      }
      if (!customText) {
        new Notice("请输入显示文字！");
        return;
      }

      // 获取选中的卡片数据
      const selectedCard = cardData.find(card => card.id === parseInt(selectedId));
      // 生成卡片HTML
      const cardHtml = `
<div>
  <a href="${customHref}" target="_blank" style="
      display: inline-flex; 
      align-items: center;
      width: 300px; 
      border: 1px solid #eee; 
      padding: 10px; 
      text-decoration: none; 
      color: #333; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin: 5px 0;
    ">
      <img src="${selectedCard.imgSrc}" style="
        width: auto; 
        height: 36px; 
        max-height: 36px; 
        max-width: 72px; 
        object-fit: contain;
      ">
      <p style="
        margin: 0 0 0 8px; 
        font-weight: 500;
        flex: 1;
      ">${customText}</p>
</a>
</div>
`;
      closeDialog();
      resolve(cardHtml);
    });

    // 回车键提交
    [hrefInput, textInput].forEach(el => {
      el.addEventListener("keypress", (e) => {
        if (e.key === "Enter") submitBtn.click();
      });
    });
  });
}

// ========== 主执行逻辑 ==========
// 1. 打开弹窗，等待用户输入
const cardHtml = await showCardGeneratorDialog();

// 2. 如果用户确认生成，在光标位置插入内容
if (cardHtml) {
  // 核心：在光标位置插入卡片HTML + 标签
  const finalContent = `\n#卡片链接\n${cardHtml}\n`;
  tp.editor.replaceRange(finalContent, cursorPos);
  
  // 可选：将光标移到插入内容末尾
  tp.editor.setCursor({
    line: cursorPos.line,
    ch: cursorPos.ch + finalContent.length
  });
  
  new Notice("✅ 卡片已插入到光标位置！");
}
%>