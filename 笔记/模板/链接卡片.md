<%*
// ========== 核心配置（可自定义） ==========
const cardData = [
  {
    id: 0,
    defaultHref: "https://example.com",
    imgSrc: "https://bkimg.cdn.bcebos.com/pic/dbb44aed2e738bd4eea32ffaad8b87d6267ff97f?x-bce-process=image/format,f_auto/quality,Q_70/resize,m_lfit,limit_1,w_536",
    text: "CSDN"
  },
  {
    id: 1,
    defaultHref: "https://example.com/tencent",
    imgSrc: "https://cloudcache.tencent-cloud.com/qcloud/portal/kit/images/slice/logo.23996906.svg",
    text: "腾讯云"
  },
  {
    id: 2,
    defaultHref: "https://example.com/feiniu",
    imgSrc: "https://static2.fnnas.com/official/fnos-logo.png",
    text: "飞牛云"
  },
  {
    id: 3,
    defaultHref: "https://example.com/feiniu2",
    imgSrc: "https://pica.zhimg.com/v2-4cd83ae3d6ca76dabecf001244a62310.jpg?source=57bbeac9",
    text: "知乎"
  },
  {
    id: 4,
    defaultHref: "https://example.com/feiniu3",
    imgSrc: "https://i0.hdslb.com/bfs/activity-plat/cover/20170614/x65z8xpm2z.png",
    text: "B站"
  }
];

// ========== 关键修复：直接获取 Obsidian 原生编辑器实例（精准定位光标） ==========
// 1. 获取当前活跃的编辑器实例（核心：替代 tp.editor）
const activeLeaf = app.workspace.activeLeaf;
if (!activeLeaf || activeLeaf.view.getMode() !== "source") {
  new Notice("❌ 请在源码模式下使用此模板！");
  return;
}
const editor = activeLeaf.view.editor; // 原生编辑器对象，稳定可靠
const cursorPos = editor.getCursor(); // 原生API获取光标位置（100%精准）

// ========== 交互式弹窗逻辑（保留原功能） ==========
async function showCardGeneratorDialog() {
  const dialogContainer = document.createElement("div");
  dialogContainer.style.cssText = `
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 9999; width: 400px;
  `;

  dialogContainer.innerHTML = `
    <div style="margin-bottom: 12px; font-weight: 600; font-size: 16px;">生成卡片链接</div>
    <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
      <select id="cardSelector" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">选择卡片样式</option>
        ${cardData.map(card => `<option value="${card.id}">${card.text}</option>`).join('')}
      </select>
      <input id="hrefInput" type="text" placeholder="输入链接地址" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
      <input id="textInput" type="text" placeholder="输入显示文字" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div style="display: flex; gap: 8px; justify-content: flex-end;">
      <button id="cancelBtn" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">取消</button>
      <button id="submitBtn" style="padding: 6px 12px; background: #2eaadc; color: white; border: none; border-radius: 4px; cursor: pointer;">生成</button>
    </div>
  `;
  document.body.appendChild(dialogContainer);

  const selector = dialogContainer.querySelector("#cardSelector");
  const hrefInput = dialogContainer.querySelector("#hrefInput");
  const textInput = dialogContainer.querySelector("#textInput");
  const submitBtn = dialogContainer.querySelector("#submitBtn");
  const cancelBtn = dialogContainer.querySelector("#cancelBtn");

  selector.addEventListener("change", (e) => {
    const selectedId = e.target.value;
    if (selectedId) {
      const selectedCard = cardData.find(card => card.id === parseInt(selectedId));
      hrefInput.value = selectedCard.defaultHref;
      textInput.value = selectedCard.text;
    } else {
      hrefInput.value = "";
      textInput.value = "";
    }
  });

  const closeDialog = () => {
    document.body.removeChild(dialogContainer);
  };

  return new Promise((resolve) => {
    cancelBtn.addEventListener("click", () => {
      closeDialog();
      resolve(null);
    });

    submitBtn.addEventListener("click", () => {
      const selectedId = selector.value;
      const customHref = hrefInput.value.trim();
      const customText = textInput.value.trim();

      if (!selectedId) {
        new Notice("请选择卡片样式！");
        return;
      }
      if (!customHref) {
        new Notice("请输入链接地址！");
        return;
      }
      if (!customText) {
        new Notice("请输入显示文字！");
        return;
      }

      const selectedCard = cardData.find(card => card.id === parseInt(selectedId));
      const cardHtml = `
<div>
  <a href="${customHref}" target="_blank" style="
      display: inline-flex; 
      align-items: center;
      width: 300px; 
      border: 1px solid #eee; 
      padding: 10px; 
      text-decoration: none; 
      color: #333; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin: 5px 0;
    ">
      <img src="${selectedCard.imgSrc}" style="
        width: auto; 
        height: 36px; 
        max-height: 36px; 
        max-width: 72px; 
        object-fit: contain;
      ">
      <p style="
        margin: 0 0 0 8px; 
        font-weight: 500;
        flex: 1;
      ">${customText}</p>
</a>
</div>
`;
      closeDialog();
      resolve(cardHtml);
    });

    [hrefInput, textInput].forEach(el => {
      el.addEventListener("keypress", (e) => {
        if (e.key === "Enter") submitBtn.click();
      });
    });
  });
}

// ========== 主执行逻辑（100%精准插入光标位置） ==========
try {
  const cardHtml = await showCardGeneratorDialog();

  if (cardHtml) {
    const finalContent = `\n#卡片链接${cardHtml}\n`;
    // 核心：用原生 Editor API 在光标位置插入内容（替代 tp.editor）
    editor.replaceRange(finalContent, cursorPos);
    
    // 可选：将光标移到插入内容的末尾（体验优化）
    const newCursorPos = {
      line: cursorPos.line,
      ch: cursorPos.ch + finalContent.length
    };
    editor.setCursor(newCursorPos);

    new Notice("✅ 卡片已精准插入到光标位置！");
  }
} catch (err) {
  console.error("模板执行错误：", err);
  new Notice("❌ 执行失败，详情见控制台！");
}
%>