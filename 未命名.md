---
title: 未命名
updateDate: 2025-11-21 11:21:56
---
```dataviewjs
// 1. 定义要插入的 HTML 结构
const htmlContent = `
<div style="position: relative; width: 100%; margin: 20px 0; box-sizing: border-box;">
  <!-- 增减分栏按钮 -->
  <div style="position: absolute; top: -20px; left: 10px; display: flex; gap: 10px; z-index: 999;">
    <button id="addColumnBtn" style="background: #6366f1; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 14px; transition: all 0.2s;">+ 新增分栏</button>
  </div>

  <!-- 分栏容器 -->
  <div id="columnContainer" style="display: flex; width: 100%; border: 3px solid #6366f1; border-radius: 12px; overflow: hidden; height: 450px; box-sizing: border-box;">
    <!-- 左分栏 -->
    <div class="column" style="flex: 0 0 50%; padding: 15px; background: #f9fafb; border-right: 2px solid #e2e8f0; box-sizing: border-box; overflow: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #6366f1;">
        <span class="column-title" contenteditable="true">分栏 1</span>
        <button class="delete-column-btn" style="background: transparent; color: #ef4444; border: none; cursor: pointer; font-size: 16px;">✕</button>
      </div>
      <div class="editor-content" style="min-height: 350px; outline: none; font-size: 15px; line-height: 1.7; color: #374151;" contenteditable="true">
        这里是分栏 1 的内容<br><br>
        ✅ 支持富文本编辑（粗体、斜体、列表等）<br>
        ✅ 直接粘贴图片（Obsidian 会自动保存）<br>
        ✅ 拖拽分隔线调整宽度
      </div>
    </div>

    <!-- 分隔线 -->
    <div class="resizer" style="width: 12px; background: rgba(99, 102, 241, 0.1); position: relative; touch-action: none; cursor: col-resize;">
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 4px; height: 80px; background: #6366f1; border-radius: 2px;"></div>
    </div>

    <!-- 右分栏 -->
    <div class="column" style="flex: 0 0 50%; padding: 15px; background: #f9fafb; box-sizing: border-box; overflow: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #6366f1;">
        <span class="column-title" contenteditable="true">分栏 2</span>
        <button class="delete-column-btn" style="background: transparent; color: #ef4444; border: none; cursor: pointer; font-size: 16px;">✕</button>
      </div>
      <div class="editor-content" style="min-height: 350px; outline: none; font-size: 15px; line-height: 1.7; color: #374151;" contenteditable="true">
        这里是分栏 2 的内容<br><br>
        <ul>
          <li>列表项 1</li>
          <li>列表项 2（支持 Markdown 语法）</li>
        </ul>
        <img src="https://picsum.photos/id/237/300/200" alt="示例图片" style="max-width: 100%; border-radius: 8px; margin: 10px 0;">
      </div>
    </div>
  </div>
</div>
`;

// 2. 渲染HTML内容
const tempDiv = document.createElement('div');
tempDiv.innerHTML = htmlContent;
dv.container.appendChild(tempDiv.firstElementChild);

// 3. 数据持久化相关函数
// 生成唯一标识符，避免不同笔记间数据冲突
const getNoteUniqueId = () => {
  // 使用当前笔记的路径作为唯一标识
  return dv.current().file.path.replace(/\//g, '_');
};

// 保存数据到localStorage
const saveColumnsData = (columns) => {
  const noteId = getNoteUniqueId();
  const data = columns.map(col => ({
    title: col.querySelector('.column-title').innerText,
    content: col.querySelector('.editor-content').innerHTML,
    width: col.style.flex
  }));
  localStorage.setItem(`multiColumnData_${noteId}`, JSON.stringify(data));
};

// 从localStorage加载数据
const loadColumnsData = () => {
  const noteId = getNoteUniqueId();
  const data = localStorage.getItem(`multiColumnData_${noteId}`);
  return data ? JSON.parse(data) : null;
};

// 封装一个创建分隔线 DOM 元素的函数
const createResizer = () => {
  const resizer = document.createElement('div');
  resizer.className = 'resizer';
  resizer.style.cssText = 'width: 12px; background: rgba(99, 102, 241, 0.1); position: relative; touch-action: none; cursor: col-resize;';
  
  const innerBar = document.createElement('div');
  innerBar.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 4px; height: 80px; background: #6366f1; border-radius: 2px;';
  
  resizer.appendChild(innerBar);
  return resizer;
};

// 4. 初始化
setTimeout(() => {
  const container = dv.container.querySelector('#columnContainer');
  const addBtn = dv.container.querySelector('#addColumnBtn');
  let resizers = Array.from(dv.container.querySelectorAll('.resizer'));
  let columns = Array.from(dv.container.querySelectorAll('.column'));

  // 从localStorage加载并恢复数据
  const savedData = loadColumnsData();
  if (savedData && savedData.length > 0) {
    // 先清空现有内容
    columns.forEach((col, index) => {
      if (index < savedData.length) {
        col.querySelector('.column-title').innerText = savedData[index].title;
        col.querySelector('.editor-content').innerHTML = savedData[index].content;
        col.style.flex = savedData[index].width;
      } else {
        // 如果保存的数据比当前分栏少，删除多余的分栏
        deleteColumn(col);
      }
    });
    
    // 如果保存的数据比分栏多，添加新分栏
    if (savedData.length > columns.length) {
      for (let i = columns.length; i < savedData.length; i++) {
        addNewColumn(savedData[i].title, savedData[i].content, savedData[i].width);
      }
    }
  }

  // 更新分栏标题
  const updateColumnTitles = () => {
    columns.forEach((col, index) => {
      // 只有在标题是默认的"分栏 X"时才更新，用户自定义标题不覆盖
      const titleEl = col.querySelector('.column-title');
      if (titleEl.innerText.startsWith('分栏 ')) {
        titleEl.innerText = `分栏 ${index + 1}`;
      }
    });
    saveColumnsData(columns); // 保存更新
  };

  // 添加新分栏的函数
  const addNewColumn = (title = '', content = '', width = '') => {
    const newColCount = columns.length + 1;
    const newWidthPercent = width || (100 / newColCount);
    
    // 如果没有指定宽度，重新分配现有分栏宽度
    if (!width) {
      columns.forEach(col => col.style.flex = `0 0 ${newWidthPercent}%`);
    }

    const newResizer = createResizer();

    // 创建新分栏
    const newColumn = document.createElement('div');
    newColumn.className = 'column';
    newColumn.style.cssText = `flex: 0 0 ${newWidthPercent}%; padding: 15px; background: #f9fafb; box-sizing: border-box; overflow: auto;`;
    newColumn.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #6366f1;">
        <span class="column-title" contenteditable="true">${title || `分栏 ${newColCount}`}</span>
        <button class="delete-column-btn" style="background: transparent; color: #ef4444; border: none; cursor: pointer; font-size: 16px;">✕</button>
      </div>
      <div class="editor-content" style="min-height: 350px; outline: none; font-size: 15px; line-height: 1.7; color: #374151;" contenteditable="true">
        ${content || '新分栏内容（可编辑，支持富文本和图片）'}
      </div>
    `;

    // 添加到容器
    container.appendChild(newResizer);
    container.appendChild(newColumn);

    // 绑定事件
    const newEditor = newColumn.querySelector('.editor-content');
    ['click', 'keydown', 'paste', 'input'].forEach(event => {
      newEditor.addEventListener(event, (e) => {
        e.stopPropagation();
        saveColumnsData(columns); // 内容变化时保存
      });
    });
    
    // 绑定标题编辑事件
    const titleEl = newColumn.querySelector('.column-title');
    titleEl.addEventListener('blur', () => {
      saveColumnsData(columns); // 标题变化时保存
    });
    
    // 绑定删除按钮事件
    newColumn.querySelector('.delete-column-btn').addEventListener('click', () => deleteColumn(newColumn));
    
    // 更新数组
    resizers.push(newResizer);
    columns.push(newColumn);
    bindResizeEvents(newResizer);
    
    return newColumn;
  };

  // 分栏宽度调整逻辑
  let isResizing = false;
  let currentResizer = null;

  const bindResizeEvents = (resizer) => {
    resizer.addEventListener('mousedown', (e) => {
      isResizing = true;
      currentResizer = resizer;
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
      e.preventDefault();
    });
  };

  resizers.forEach(bindResizeEvents);

  document.addEventListener('mousemove', (e) => {
    if (!isResizing || !currentResizer) return;
    const containerRect = container.getBoundingClientRect();
    const resizerIndex = resizers.indexOf(currentResizer);
    const leftCol = columns[resizerIndex];
    const rightCol = columns[resizerIndex + 1];
    const mouseX = Math.max(0, Math.min(e.clientX - containerRect.left, containerRect.width));
    const leftWidthPercent = (mouseX / containerRect.width) * 100;
    const rightWidthPercent = 100 - leftWidthPercent;

    if (leftWidthPercent >= 15 && rightWidthPercent >= 15) {
      leftCol.style.flex = `0 0 ${leftWidthPercent}%`;
      rightCol.style.flex = `0 0 ${rightWidthPercent}%`;
    }
  });

  document.addEventListener('mouseup', () => {
    if (isResizing) {
      isResizing = false;
      currentResizer = null;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
      saveColumnsData(columns); // 调整宽度后保存
    }
  });

  // 添加分栏逻辑
  addBtn.addEventListener('click', () => {
    addNewColumn();
  });

  // 删除分栏函数
  const deleteColumn = (column) => {
    if (columns.length <= 1) return; // 至少保留一个分栏
    
    const index = columns.indexOf(column);
    const resizerToRemove = resizers[index];
    
    // 从 DOM 中移除
    container.removeChild(column);
    if (resizerToRemove) {
      container.removeChild(resizerToRemove);
    }
    
    // 从数组中移除
    columns.splice(index, 1);
    resizers.splice(index, 1);
    
    // 重新分配宽度
    const newWidthPercent = 100 / columns.length;
    columns.forEach(col => col.style.flex = `0 0 ${newWidthPercent}%`);
    
    // 更新标题编号
    updateColumnTitles();
  };

  // 绑定初始删除按钮事件
  dv.container.querySelectorAll('.delete-column-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const column = btn.closest('.column');
      deleteColumn(column);
    });
  });

  // 为初始的 .editor-content 元素绑定事件
  dv.container.querySelectorAll('.editor-content').forEach(editor => {
    ['click', 'keydown', 'paste', 'input'].forEach(event => {
      editor.addEventListener(event, (e) => {
        e.stopPropagation();
        saveColumnsData(columns); // 内容变化时保存
      });
    });
  });
  
  // 为初始的标题元素绑定事件
  dv.container.querySelectorAll('.column-title').forEach(title => {
    title.addEventListener('blur', () => {
      saveColumnsData(columns); // 标题变化时保存
    });
  });

}, 0);

```
